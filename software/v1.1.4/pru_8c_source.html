<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>RocketLogger: pru.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RocketLogger
   &#160;<span id="projectnumber">1.1.4</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pru_8c_source.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">pru.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="pru_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;stdint.h&gt;</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &lt;sys/ipc.h&gt;</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;sys/sem.h&gt;</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;sys/types.h&gt;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="file__handling_8h.html">file_handling.h</a>&quot;</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="util_8h.html">util.h</a>&quot;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="web_8h.html">web.h</a>&quot;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="pru_8h.html">pru.h</a>&quot;</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">// PRU TIMEOUT WRAPPER</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="pru_8c.html#ad2718fc743dfe4460461ce938718ffa0">   47</a></span>&#160;pthread_mutex_t <a class="code" href="pru_8c.html#ad2718fc743dfe4460461ce938718ffa0">waiting</a> = PTHREAD_MUTEX_INITIALIZER;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="pru_8c.html#aba47632bdb6d911ae56229c7ef017723">   50</a></span>&#160;pthread_cond_t <a class="code" href="pru_8c.html#aba47632bdb6d911ae56229c7ef017723">done</a> = PTHREAD_COND_INITIALIZER;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="pru_8h.html#a8003e1ac7da2ee5ce28b70417f12ecd5">   56</a></span>&#160;<span class="keywordtype">void</span>* <a class="code" href="pru_8c.html#a8003e1ac7da2ee5ce28b70417f12ecd5">pru_wait_event</a>(<span class="keywordtype">void</span>* voidEvent) {</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keyword">event</span> = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)voidEvent);</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="comment">// allow the thread to be killed at any time</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="keywordtype">int</span> oldtype;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    pthread_setcanceltype(PTHREAD_CANCEL_ASYNCHRONOUS, &amp;oldtype);</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// wait for pru event</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    prussdrv_pru_wait_event(event);</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">// notify main program</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    pthread_cond_signal(&amp;<a class="code" href="pru_8c.html#aba47632bdb6d911ae56229c7ef017723">done</a>);</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;}</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="pru_8h.html#a4d0ce3530455f19eaab044e35a461c4f">   79</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="pru_8c.html#a4d0ce3530455f19eaab044e35a461c4f">pru_wait_event_timeout</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> event, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeout) {</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keyword">struct </span>timespec abs_time;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    pthread_t tid;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keywordtype">int</span> err;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    pthread_mutex_lock(&amp;<a class="code" href="pru_8c.html#ad2718fc743dfe4460461ce938718ffa0">waiting</a>);</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="comment">// pthread cond_timedwait expects an absolute time to wait until</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    clock_gettime(CLOCK_REALTIME, &amp;abs_time);</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    abs_time.tv_sec += timeout;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    pthread_create(&amp;tid, NULL, <a class="code" href="pru_8c.html#a8003e1ac7da2ee5ce28b70417f12ecd5">pru_wait_event</a>, (<span class="keywordtype">void</span>*)&amp;event);</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    err = pthread_cond_timedwait(&amp;<a class="code" href="pru_8c.html#aba47632bdb6d911ae56229c7ef017723">done</a>, &amp;<a class="code" href="pru_8c.html#ad2718fc743dfe4460461ce938718ffa0">waiting</a>, &amp;abs_time);</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keywordflow">if</span> (!err) {</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        pthread_mutex_unlock(&amp;<a class="code" href="pru_8c.html#ad2718fc743dfe4460461ce938718ffa0">waiting</a>);</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    }</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="keywordflow">return</span> err;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;}</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">// PRU MEMORY MAPPING</span></div><div class="line"><a name="l00106"></a><span class="lineno"><a class="line" href="pru_8c.html#af73086371d580a3406c0aaa73420ade2">  106</a></span>&#160;<span class="comment"></span><span class="keywordtype">void</span>* <a class="code" href="pru_8c.html#af73086371d580a3406c0aaa73420ade2">pru_map_memory</a>(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="comment">// get pru memory location and size</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pru_memory = <a class="code" href="util_8c.html#a67a3cc56d4440aca0b206f54add44ee2">read_file_value</a>(<a class="code" href="pru_8h.html#aa284ae96969e8487b1d1f03b6215a98c">MMAP_FILE</a> <span class="stringliteral">&quot;addr&quot;</span>);</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = <a class="code" href="util_8c.html#a67a3cc56d4440aca0b206f54add44ee2">read_file_value</a>(<a class="code" href="pru_8h.html#aa284ae96969e8487b1d1f03b6215a98c">MMAP_FILE</a> <span class="stringliteral">&quot;size&quot;</span>);</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="comment">// memory map file</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keywordtype">int</span> fd;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keywordflow">if</span> ((fd = open(<span class="stringliteral">&quot;/dev/mem&quot;</span>, O_RDWR | O_SYNC)) == -1) {</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;failed to open /dev/mem&quot;</span>);</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    }</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="comment">// map shared memory into userspace</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordtype">void</span>* pru_mmap = mmap(0, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd,</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                          (off_t)pru_memory);</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">if</span> (pru_mmap == (<span class="keywordtype">void</span>*)-1) {</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;failed to map base address&quot;</span>);</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    }</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    close(fd);</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">return</span> pru_mmap;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;}</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno"><a class="line" href="pru_8c.html#acc3c091f1563ead66ab59962f3cfdcc5">  138</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="pru_8c.html#acc3c091f1563ead66ab59962f3cfdcc5">pru_unmap_memory</a>(<span class="keywordtype">void</span>* pru_mmap) {</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="comment">// get pru memory size</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = <a class="code" href="util_8c.html#a67a3cc56d4440aca0b206f54add44ee2">read_file_value</a>(<a class="code" href="pru_8h.html#aa284ae96969e8487b1d1f03b6215a98c">MMAP_FILE</a> <span class="stringliteral">&quot;size&quot;</span>);</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordflow">if</span> (munmap(pru_mmap, size) == -1) {</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;failed to unmap memory&quot;</span>);</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    }</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;}</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">// PRU INITIALISATION</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00157"></a><span class="lineno"><a class="line" href="pru_8h.html#aca3acbd32d5951672e7b2b1523f3c2fa">  157</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="pru_8c.html#aca3acbd32d5951672e7b2b1523f3c2fa">pru_set_state</a>(<a class="code" href="pru_8h.html#ac1d7cd733ef08a5dde1d84664788bfa5">rl_pru_state</a> <a class="code" href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a>) {</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    prussdrv_pru_write_memory(PRUSS0_PRU0_DATARAM, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)&amp;state,</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                              <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;}</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno"><a class="line" href="pru_8h.html#ab784943bfd599f19fddb98647d2f253c">  167</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="pru_8c.html#ab784943bfd599f19fddb98647d2f253c">pru_init</a>(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">// init PRU</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    tpruss_intc_initdata pruss_intc_initdata = PRUSS_INTC_INITDATA;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    prussdrv_init();</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keywordflow">if</span> (prussdrv_open(PRU_EVTOUT_0) == -1) {</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;failed to open PRU&quot;</span>);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    }</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    prussdrv_pruintc_init(&amp;pruss_intc_initdata);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;}</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00189"></a><span class="lineno"><a class="line" href="pru_8h.html#a4707ea56eb19ed66966c1d92567b120c">  189</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="pru_8c.html#a4707ea56eb19ed66966c1d92567b120c">pru_data_setup</a>(<span class="keyword">struct</span> <a class="code" href="structpru__data__struct.html">pru_data_struct</a>* pru, <span class="keyword">struct</span> <a class="code" href="structrl__conf.html">rl_conf</a>* conf,</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                   uint32_t avg_factor) {</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    uint32_t pru_sample_rate;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="comment">// set state</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#acb73317cb1354c578448512726c6fc2b">mode</a> == <a class="code" href="types_8h.html#a1a6b6fb557d8d37d59700faf4e4c9167ab8c27c7822bc67c502ca70738896680f">LIMIT</a>) {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a9a124ab5c8c3af75e1ab43b678a2b211">state</a> = <a class="code" href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077a1b1bd13d3255a25810bfe9328cb00f33">PRU_LIMIT</a>;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a9a124ab5c8c3af75e1ab43b678a2b211">state</a> = <a class="code" href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077a126d7c453b951c98cc537ef0a69082a5">PRU_CONTINUOUS</a>;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    }</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="comment">// set sampling rate configuration</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordflow">switch</span> (conf-&gt;<a class="code" href="structrl__conf.html#a3018547f3ec09e34dd9c639eb15fd0d5">sample_rate</a>) {</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">case</span> 1:</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#aadecb1977e30da2f62766f1fcb8b1f95">K1</a>;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="keywordflow">case</span> 10:</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#aadecb1977e30da2f62766f1fcb8b1f95">K1</a>;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordflow">case</span> 100:</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#aadecb1977e30da2f62766f1fcb8b1f95">K1</a>;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">case</span> 1000:</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#aadecb1977e30da2f62766f1fcb8b1f95">K1</a>;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">case</span> 2000:</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#ab6d0e745059aded06587e4b6933bca0b">K2</a>;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keywordflow">case</span> 4000:</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#ab45eb721b96f7dc4898425c6bdc0ae49">K4</a>;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">case</span> 8000:</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#a66a8e71a3df40b69d3a5483c3cd972e0">K8</a>;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">case</span> 16000:</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#a0c1b4ad6599de0f7b18674bf6c3a22fe">K16</a>;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a>;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="keywordflow">case</span> 32000:</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#ad3d8f27a31684427b780e4d6466fd2a3">K32</a>;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a9986bad57c98d8a0d316444fc66de053">PRECISION_LOW</a>;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keywordflow">case</span> 64000:</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        pru_sample_rate = <a class="code" href="pru_8h.html#a9a4bd57068f054cec3fd02dbc65d2f5d">K64</a>;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">precision</a> = <a class="code" href="pru_8h.html#a9986bad57c98d8a0d316444fc66de053">PRECISION_LOW</a>;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> = <a class="code" href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a>;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;wrong sample rate&quot;</span>);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    }</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="comment">// set buffer infos</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#a7d58cf74cf96a78347f4a63a5b92b56f">sample_limit</a> = conf-&gt;<a class="code" href="structrl__conf.html#aed527641b352701ced22fb0b97a549d0">sample_limit</a> * avg_factor;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a> = (conf-&gt;<a class="code" href="structrl__conf.html#a3018547f3ec09e34dd9c639eb15fd0d5">sample_rate</a> * avg_factor) / conf-&gt;<a class="code" href="structrl__conf.html#afd4e6a8ccbb7b43ce6a48f347c6c496d">update_rate</a>;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    uint32_t buffer_size_bytes =</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        pru-&gt;<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a> * (pru-&gt;<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> * <a class="code" href="types_8h.html#ae5597ce31d23d11493e6e674fe257d73">NUM_CHANNELS</a> + <a class="code" href="types_8h.html#ad7ee97d57258ec2cb4278dba11dcf393">PRU_DIG_SIZE</a>) +</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <a class="code" href="types_8h.html#a6313dcd0bf77984a880d87a36d409082">PRU_BUFFER_STATUS_SIZE</a>;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#a009029f956cb377955c1710e25237362">buffer0_location</a> = <a class="code" href="util_8c.html#a67a3cc56d4440aca0b206f54add44ee2">read_file_value</a>(<a class="code" href="pru_8h.html#aa284ae96969e8487b1d1f03b6215a98c">MMAP_FILE</a> <span class="stringliteral">&quot;addr&quot;</span>);</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#ab5654be612b10601bc48c878f512143a">buffer1_location</a> = pru-&gt;<a class="code" href="structpru__data__struct.html#a009029f956cb377955c1710e25237362">buffer0_location</a> + buffer_size_bytes;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="comment">// set commands</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#a9b2b63675bd287b19168db44db53583c">number_commands</a> = <a class="code" href="pru_8h.html#a07a6f4f9ee069b2323f2fccafe018bd8">NUMBER_ADC_COMMANDS</a>;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[0] = <a class="code" href="pru_8h.html#ab702106cf3b3e96750b6845ded4e0299">RESET</a>;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[1] = <a class="code" href="pru_8h.html#a993739431380c1beb0e04a8826c1b7e3">SDATAC</a>;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[2] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#a8d128687074c874210b0c9dada3d8ca7">CONFIG3</a> | <a class="code" href="pru_8h.html#a05874079216c802a325d9f7251b6e6d8">CONFIG3DEFAULT</a>; <span class="comment">// write configuration</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[3] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#ae28dbf424985dc1c58ae7dbc5a0926b9">CONFIG1</a> | <a class="code" href="pru_8h.html#a3c2a19f5e92f0c34ae9c541000cf72e9">CONFIG1DEFAULT</a> | pru_sample_rate;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="comment">// set channel gains</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[4] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#a8fea370fa35eeb28355a58a40783ec99">CH1SET</a> | <a class="code" href="pru_8h.html#a447d200a726c25fd923af631584c5597">GAIN2</a>;  <span class="comment">// High Range A</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[5] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#a3e8ab2c505cc6f00a1807a151a9ebcdb">CH2SET</a> | <a class="code" href="pru_8h.html#a447d200a726c25fd923af631584c5597">GAIN2</a>;  <span class="comment">// High Range B</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[6] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#a70dccc80e613cfc0eea471983aecc229">CH3SET</a> | <a class="code" href="pru_8h.html#ae4549ec8ad2b570fc4a3cce6a53c086a">GAIN1</a>;  <span class="comment">// Medium Range</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[7] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#a0d9979e6e1d8b4e7727063b2660ac10b">CH4SET</a> | <a class="code" href="pru_8h.html#ae4549ec8ad2b570fc4a3cce6a53c086a">GAIN1</a>;  <span class="comment">// Low Range A</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[8] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#aff7800e91abe1001d9e3c9febc34e0d3">CH5SET</a> | <a class="code" href="pru_8h.html#ae4549ec8ad2b570fc4a3cce6a53c086a">GAIN1</a>;  <span class="comment">// Low Range B</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[9] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#a4708b2ba51cdb3a41817f06b8982657f">CH6SET</a> | <a class="code" href="pru_8h.html#ae4549ec8ad2b570fc4a3cce6a53c086a">GAIN1</a>;  <span class="comment">// Voltage 1</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[10] = <a class="code" href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a> | <a class="code" href="pru_8h.html#a018ba15c7462bc82cae0c3695d4c0ed0">CH7SET</a> | <a class="code" href="pru_8h.html#ae4549ec8ad2b570fc4a3cce6a53c086a">GAIN1</a>; <span class="comment">// Voltage 2</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    pru-&gt;<a class="code" href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">commands</a>[11] = <a class="code" href="pru_8h.html#aae10ea86a4b725e7fe6149829a9a0004">RDATAC</a>;                <span class="comment">// continuous reading</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;}</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div><div class="line"><a name="l00296"></a><span class="lineno"><a class="line" href="pru_8h.html#a2429d8197f575e9610f73229d9a46de8">  296</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="pru_8c.html#a8beb411e955b815605865150d2b12832">pru_sample</a>(FILE* data_file, FILE* ambient_file, <span class="keyword">struct</span> <a class="code" href="structrl__conf.html">rl_conf</a>* conf,</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;               <span class="keywordtype">char</span>* file_comment) {</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="comment">// average (for low rates)</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    uint32_t avg_factor = 1;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#a3018547f3ec09e34dd9c639eb15fd0d5">sample_rate</a> &lt; <a class="code" href="types_8h.html#a9cd6c40e97ff3f7786714708a756e064">MIN_ADC_RATE</a>) {</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        avg_factor = <a class="code" href="types_8h.html#a9cd6c40e97ff3f7786714708a756e064">MIN_ADC_RATE</a> / conf-&gt;<a class="code" href="structrl__conf.html#a3018547f3ec09e34dd9c639eb15fd0d5">sample_rate</a>;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    }</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="comment">// METER</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#acb73317cb1354c578448512726c6fc2b">mode</a> == <a class="code" href="types_8h.html#a1a6b6fb557d8d37d59700faf4e4c9167ae2e6be25b55c130066f8efb3490b3826">METER</a>) {</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <a class="code" href="meter_8c.html#aad154a6600f07718dd4c981eff256b9a">meter_init</a>();</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    }</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="comment">// WEBSERVER</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="rl__server_8c.html#a9825b926ad2a4aa0e6688dc15b2d9a23">sem_id</a> = -1;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="keyword">struct </span><a class="code" href="structweb__shm.html">web_shm</a>* <a class="code" href="rl__server_8c.html#ac78ce7090cafb1d77cebd9711187f2e4">web_data</a> = (<span class="keyword">struct </span><a class="code" href="structweb__shm.html">web_shm</a>*)-1;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#a1c3f8925c62557844a0db974c5cffeaf">enable_web_server</a> == 1) {</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        <span class="comment">// semaphores</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        sem_id = <a class="code" href="sem_8c.html#a51ff2c8ef965d91bf86b978f6a7f1e1e">create_sem</a>(<a class="code" href="types_8h.html#a299ffb74b818be524ba85f23e7978906">SEM_KEY</a>, <a class="code" href="types_8h.html#a21618178aad39fdcaf3152756081362d">NUM_SEMS</a>);</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <a class="code" href="sem_8c.html#ac67b4de40d56892078c0e6156691f578">set_sem</a>(sem_id, <a class="code" href="types_8h.html#a0c5903cbca2638009928b86b57e223c1">DATA_SEM</a>, 1);</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="comment">// shared memory</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        web_data = <a class="code" href="web_8c.html#a9e5e1d279c4b144c577a701cc9528e5f">web_create_shm</a>();</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="comment">// determine web channels count (merged)</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="keywordtype">int</span> num_web_channels = <a class="code" href="util_8c.html#aae37b3d3b6a01f95a54b30585d022b64">count_channels</a>(conf-&gt;<a class="code" href="structrl__conf.html#a1bb42e09a4f26c8539c8e56961adbd46">channels</a>);</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#a1bb42e09a4f26c8539c8e56961adbd46">channels</a>[<a class="code" href="types_8h.html#a08aa59d6c1bdc9cf2882727937263665">I1H_INDEX</a>] == <a class="code" href="types_8h.html#ae4df85c08e7e08883c9bd1ffb4cd78ca">CHANNEL_ENABLED</a> &amp;&amp;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            conf-&gt;<a class="code" href="structrl__conf.html#a1bb42e09a4f26c8539c8e56961adbd46">channels</a>[<a class="code" href="types_8h.html#acc71aee1a86f329b7380fcd877d8af26">I1L_INDEX</a>] == <a class="code" href="types_8h.html#ae4df85c08e7e08883c9bd1ffb4cd78ca">CHANNEL_ENABLED</a>) {</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            num_web_channels--;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        }</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#a1bb42e09a4f26c8539c8e56961adbd46">channels</a>[<a class="code" href="types_8h.html#ae3eed11e25c123a4136bd1ea91e5f675">I2H_INDEX</a>] == <a class="code" href="types_8h.html#ae4df85c08e7e08883c9bd1ffb4cd78ca">CHANNEL_ENABLED</a> &amp;&amp;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            conf-&gt;<a class="code" href="structrl__conf.html#a1bb42e09a4f26c8539c8e56961adbd46">channels</a>[<a class="code" href="types_8h.html#a53020ec87954ae4e18c451f4fbecbb5e">I2L_INDEX</a>] == <a class="code" href="types_8h.html#ae4df85c08e7e08883c9bd1ffb4cd78ca">CHANNEL_ENABLED</a>) {</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            num_web_channels--;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        }</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#a9c750f476bb28805f6e4c642060e6c26">digital_inputs</a> == <a class="code" href="types_8h.html#a7652fb1566ba57e60f1bf36cf15729c7">DIGITAL_INPUTS_ENABLED</a>) {</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            num_web_channels += <a class="code" href="types_8h.html#a3ec7fa75993910b58eeea355257a8a40">NUM_DIGITAL_INPUTS</a>;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        }</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        web_data-&gt;<a class="code" href="structweb__shm.html#a77b5891b6761d7f5763e9cde2ed73dbd">num_channels</a> = num_web_channels;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="comment">// web buffer sizes</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keywordtype">int</span> <a class="code" href="rl__server_8c.html#a14e52d9e39f9a51dabdbdc4a15ec7d48">buffer_sizes</a>[<a class="code" href="web_8h.html#adff06b81f16f93135a073319feae1be3">WEB_RING_BUFFER_COUNT</a>] = {<a class="code" href="web_8h.html#aded994583757000c85dd518823c5ac1b">BUFFER1_SIZE</a>, <a class="code" href="web_8h.html#a85839eeebbf105029b459c112ca62fe1">BUFFER10_SIZE</a>,</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                                                   <a class="code" href="web_8h.html#a7484e405104d2f62234131755669185c">BUFFER100_SIZE</a>};</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="web_8h.html#adff06b81f16f93135a073319feae1be3">WEB_RING_BUFFER_COUNT</a>; i++) {</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            <span class="keywordtype">int</span> web_buffer_element_size =</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                buffer_sizes[i] * num_web_channels * <span class="keyword">sizeof</span>(int64_t);</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            <span class="keywordtype">int</span> web_buffer_length = <a class="code" href="web_8h.html#a61ac01a77bd9c1074fa93bd1a099f010">NUM_WEB_POINTS</a> / buffer_sizes[i];</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            <a class="code" href="web_8c.html#a35b6ae887b599672cf637a293003aed9">web_buffer_reset</a>(&amp;web_data-&gt;<a class="code" href="structweb__shm.html#a1240d96092b9f4b48e16fa97196216b2">buffer</a>[i], web_buffer_element_size,</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                             web_buffer_length);</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        }</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    }</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="comment">// PRU SETUP</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">// Map the PRU&#39;s interrupts</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    tpruss_intc_initdata pruss_intc_initdata = PRUSS_INTC_INITDATA;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    prussdrv_pruintc_init(&amp;pruss_intc_initdata);</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="comment">// setup PRU</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpru__data__struct.html">pru_data_struct</a> pru;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <a class="code" href="pru_8c.html#a4707ea56eb19ed66966c1d92567b120c">pru_data_setup</a>(&amp;pru, conf, avg_factor);</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> number_buffers =</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <a class="code" href="util_8c.html#a04f4c5f21d5257f6b867ec19c6988156">ceil_div</a>(conf-&gt;<a class="code" href="structrl__conf.html#aed527641b352701ced22fb0b97a549d0">sample_limit</a> * avg_factor, pru.<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a>);</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buffer_size_bytes =</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        pru.<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a> * (pru.<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a> * <a class="code" href="types_8h.html#ae5597ce31d23d11493e6e674fe257d73">NUM_CHANNELS</a> + <a class="code" href="types_8h.html#ad7ee97d57258ec2cb4278dba11dcf393">PRU_DIG_SIZE</a>) +</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <a class="code" href="types_8h.html#a6313dcd0bf77984a880d87a36d409082">PRU_BUFFER_STATUS_SIZE</a>;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="comment">// check memory size</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_size = <a class="code" href="util_8c.html#a67a3cc56d4440aca0b206f54add44ee2">read_file_value</a>(<a class="code" href="pru_8h.html#aa284ae96969e8487b1d1f03b6215a98c">MMAP_FILE</a> <span class="stringliteral">&quot;size&quot;</span>);</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordflow">if</span> (2 * buffer_size_bytes &gt; max_size) {</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;not enough memory allocated. Run:\n  rmmod uio_pruss\n  &quot;</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                      <span class="stringliteral">&quot;modprobe uio_pruss extram_pool_sz=0x%06x&quot;</span>,</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;               2 * buffer_size_bytes);</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        pru.<a class="code" href="structpru__data__struct.html#a9a124ab5c8c3af75e1ab43b678a2b211">state</a> = <a class="code" href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077aa1dc6393949d4482ff3e195bd85598f0">PRU_OFF</a>;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    }</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="comment">// map PRU memory into userspace</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordtype">void</span>* buffer0 = <a class="code" href="pru_8c.html#af73086371d580a3406c0aaa73420ade2">pru_map_memory</a>();</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordtype">void</span>* buffer1 = buffer0 + buffer_size_bytes;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="comment">// DATA FILE STORING</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="comment">// file header lead-in</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="keyword">struct </span><a class="code" href="structrl__file__header.html">rl_file_header</a> file_header;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <a class="code" href="file__handling_8c.html#a3b344b69b354ebdf3cf8d8735de3d935">file_setup_lead_in</a>(&amp;(file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>), conf);</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="comment">// channel array</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordtype">int</span> total_channel_count = file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#af92f62ea3f9a70862630a84b31e97482">channel_bin_count</a> +</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                              file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#aa2cb152a2f9b5b6cc52f7e49c06ed199">channel_count</a>;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keyword">struct </span><a class="code" href="structrl__file__channel.html">rl_file_channel</a> file_channel[total_channel_count];</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    file_header.<a class="code" href="structrl__file__header.html#a1aecd54363b81500f412b50cb2d5f2f5">channel</a> = file_channel;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="comment">// complete file header</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <a class="code" href="file__handling_8c.html#a1f114cf1836475c8a1d2101c7f62ff23">file_setup_header</a>(&amp;file_header, conf, file_comment);</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="comment">// store header</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#ae6a5bf7b6cf3b25bb50fe92c5d322811">file_format</a> == <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa3dba92f17ebb0d7efe6056d51e9acdc7">BIN</a>) {</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <a class="code" href="file__handling_8c.html#aa09c799f4b81e3b8ca5f08ac651a4b4e">file_store_header_bin</a>(data_file, &amp;file_header);</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structrl__conf.html#ae6a5bf7b6cf3b25bb50fe92c5d322811">file_format</a> == <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa2b10dde645e767164fc3de2ddbf14399">CSV</a>) {</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <a class="code" href="file__handling_8c.html#a0e1af80ad5108aa7d82d65692ebb716d">file_store_header_csv</a>(data_file, &amp;file_header);</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    }</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="comment">// AMBIENT FILE STORING</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <span class="comment">// file header lead-in</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="keyword">struct </span><a class="code" href="structrl__file__header.html">rl_file_header</a> ambient_file_header;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">// channel array</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keyword">struct </span><a class="code" href="structrl__file__channel.html">rl_file_channel</a> ambient_file_channel[conf-&gt;ambient.sensor_count];</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;ambient.enabled == <a class="code" href="types_8h.html#a8e2c970dfb447f044dc6a775cd8d14e4">AMBIENT_ENABLED</a>) {</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <a class="code" href="ambient_8c.html#a40f29e027672a26cb7a136af8635b775">ambient_setup_lead_in</a>(&amp;(ambient_file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>), conf);</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="comment">// channel array</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        ambient_file_header.<a class="code" href="structrl__file__header.html#a1aecd54363b81500f412b50cb2d5f2f5">channel</a> = ambient_file_channel;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">// complete file header</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <a class="code" href="ambient_8c.html#ab77fe35d0811fec079d975b6e7534cc8">ambient_setup_header</a>(&amp;ambient_file_header, conf, file_comment);</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="comment">// store header</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <a class="code" href="file__handling_8c.html#aa09c799f4b81e3b8ca5f08ac651a4b4e">file_store_header_bin</a>(ambient_file, &amp;ambient_file_header);</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    }</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="comment">// EXECUTION</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="comment">// write configuration to PRU memory</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    prussdrv_pru_write_memory(PRUSS0_PRU0_DATARAM, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)&amp;pru,</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                              <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpru__data__struct.html">pru_data_struct</a>));</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="comment">// run SPI on PRU0</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="keywordflow">if</span> (prussdrv_exec_program(0, <a class="code" href="pru_8h.html#a1dd039bdaf032f25ea184090c794f22f">PRU_CODE</a>) &lt; 0) {</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;PRU code not found&quot;</span>);</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        pru.<a class="code" href="structpru__data__struct.html#a9a124ab5c8c3af75e1ab43b678a2b211">state</a> = <a class="code" href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077aa1dc6393949d4482ff3e195bd85598f0">PRU_OFF</a>;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    }</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="comment">// wait for first PRU event</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="pru_8c.html#a4d0ce3530455f19eaab044e35a461c4f">pru_wait_event_timeout</a>(PRU_EVTOUT_0, <a class="code" href="pru_8h.html#a56f883236138dc4363750263a4739b30">PRU_TIMEOUT</a>) == ETIMEDOUT) {</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="comment">// timeout occured</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;PRU not responding&quot;</span>);</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        pru.<a class="code" href="structpru__data__struct.html#a9a124ab5c8c3af75e1ab43b678a2b211">state</a> = <a class="code" href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077aa1dc6393949d4482ff3e195bd85598f0">PRU_OFF</a>;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    }</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="comment">// clear event</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    prussdrv_pru_clear_event(PRU_EVTOUT_0, PRU0_ARM_INTERRUPT);</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordtype">void</span>* buffer_addr;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="keyword">struct </span><a class="code" href="structtime__stamp.html">time_stamp</a> timestamp_monotonic;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="keyword">struct </span><a class="code" href="structtime__stamp.html">time_stamp</a> timestamp_realtime;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    uint32_t buffers_lost = 0;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    uint32_t buffer_samples_count; <span class="comment">// number of samples per buffer</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    uint32_t num_files = 1;        <span class="comment">// number of files stored</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    uint8_t skipped_buffers = 0;   <span class="comment">// skipped buffers for ambient reading</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="comment">// sampling started</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a3ef63fab68fb13f583327fe7142eeee3">sampling</a> = <a class="code" href="types_8h.html#a259c9d48abfd554f093c9a9fe0d9873cabd46128544cc5273b190363804c58aaf">SAMPLING_ON</a>;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <a class="code" href="util_8c.html#a3195667ecf2a5a6383a1ea38345ad8ef">write_status</a>(&amp;<a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>);</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="comment">// continuous sampling loop</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="keywordflow">for</span> (uint32_t i = 0;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;         <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a3ef63fab68fb13f583327fe7142eeee3">sampling</a> == <a class="code" href="types_8h.html#a259c9d48abfd554f093c9a9fe0d9873cabd46128544cc5273b190363804c58aaf">SAMPLING_ON</a> &amp;&amp; <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a89c4d04cc0ca33665db4097e304c90f9">state</a> == <a class="code" href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90a667912439842b69502b5534c329bf9fa">RL_RUNNING</a> &amp;&amp;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;         !(conf-&gt;mode == <a class="code" href="types_8h.html#a1a6b6fb557d8d37d59700faf4e4c9167ab8c27c7822bc67c502ca70738896680f">LIMIT</a> &amp;&amp; i &gt;= number_buffers);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;         i++) {</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;file_format != <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aaaa33265d2e12fe02833b6564507c7ac2">NO_FILE</a>) {</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            <span class="comment">// check if max file size reached</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;            uint64_t file_size = (uint64_t)ftello(data_file);</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            uint64_t margin =</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                conf-&gt;sample_rate * <span class="keyword">sizeof</span>(int32_t) * (<a class="code" href="types_8h.html#ae5597ce31d23d11493e6e674fe257d73">NUM_CHANNELS</a> + 1) +</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structtime__stamp.html">time_stamp</a>);</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;            <span class="keywordflow">if</span> (conf-&gt;max_file_size != 0 &amp;&amp;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                file_size + margin &gt; conf-&gt;max_file_size) {</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                <span class="comment">// close old data file</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                fclose(data_file);</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                <span class="comment">// determine new file name</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                <span class="keywordtype">char</span> file_name[<a class="code" href="types_8h.html#a9eb6992d76f02128388ae95c0415604a">MAX_PATH_LENGTH</a>];</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                <span class="keywordtype">char</span> new_file_ending[<a class="code" href="types_8h.html#a9eb6992d76f02128388ae95c0415604a">MAX_PATH_LENGTH</a>];</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                strcpy(file_name, conf-&gt;file_name);</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                <span class="comment">// search for last .</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                <span class="keywordtype">char</span> target = <span class="charliteral">&#39;.&#39;</span>;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                <span class="keywordtype">char</span>* file_ending = file_name;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                <span class="keywordflow">while</span> (strchr(file_ending, target) != NULL) {</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                    file_ending = strchr(file_ending, target);</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                    file_ending++; <span class="comment">// Increment file_ending, otherwise we&#39;ll</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                                   <span class="comment">// find target at the same location</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                }</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                file_ending--;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                <span class="comment">// add file number</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                sprintf(new_file_ending, <span class="stringliteral">&quot;_p%d&quot;</span>, num_files);</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                strcat(new_file_ending, file_ending);</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                strcpy(file_ending, new_file_ending);</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                <span class="comment">// open new data file</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                data_file = fopen(file_name, <span class="stringliteral">&quot;w+&quot;</span>);</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                <span class="comment">// update header for new file</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#acb3586e15d269a3b56f34e7e6573c698">data_block_count</a> = 0;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#a9f3346477fae778da2f729566b8998b9">sample_count</a> = 0;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                <span class="comment">// store header</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                <span class="keywordflow">if</span> (conf-&gt;file_format == <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa3dba92f17ebb0d7efe6056d51e9acdc7">BIN</a>) {</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                    <a class="code" href="file__handling_8c.html#aa09c799f4b81e3b8ca5f08ac651a4b4e">file_store_header_bin</a>(data_file, &amp;file_header);</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (conf-&gt;file_format == <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa2b10dde645e767164fc3de2ddbf14399">CSV</a>) {</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                    <a class="code" href="file__handling_8c.html#a0e1af80ad5108aa7d82d65692ebb716d">file_store_header_csv</a>(data_file, &amp;file_header);</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                }</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a748005382152808a72b1a9177d9dc806">INFO</a>, <span class="stringliteral">&quot;new datafile: %s&quot;</span>, file_name);</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                <span class="comment">// AMBIENT FILE</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                <span class="keywordflow">if</span> (conf-&gt;ambient.enabled == <a class="code" href="types_8h.html#a8e2c970dfb447f044dc6a775cd8d14e4">AMBIENT_ENABLED</a>) {</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                    <span class="comment">// close old ambient file</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                    fclose(ambient_file);</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                    <span class="comment">// determine new file name</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                    strcpy(file_name, conf-&gt;ambient.file_name);</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                    <span class="comment">// search for last .</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                    file_ending = file_name;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                    <span class="keywordflow">while</span> (strchr(file_ending, target) != NULL) {</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                        file_ending = strchr(file_ending, target);</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                        file_ending++; <span class="comment">// Increment file_ending, otherwise we&#39;ll</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                                       <span class="comment">// find target at the same location</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                    }</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                    file_ending--;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                    <span class="comment">// add file number</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                    sprintf(new_file_ending, <span class="stringliteral">&quot;_p%d&quot;</span>, num_files);</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                    strcat(new_file_ending, file_ending);</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                    strcpy(file_ending, new_file_ending);</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                    <span class="comment">// open new ambient file</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                    ambient_file = fopen(file_name, <span class="stringliteral">&quot;w+&quot;</span>);</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                    <span class="comment">// update header for new file</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                    ambient_file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#acb3586e15d269a3b56f34e7e6573c698">data_block_count</a> = 0;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                    ambient_file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#a9f3346477fae778da2f729566b8998b9">sample_count</a> = 0;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                    <span class="comment">// store header</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                    <a class="code" href="file__handling_8c.html#aa09c799f4b81e3b8ca5f08ac651a4b4e">file_store_header_bin</a>(ambient_file, &amp;ambient_file_header);</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                    <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a748005382152808a72b1a9177d9dc806">INFO</a>, <span class="stringliteral">&quot;new ambient-file: %s&quot;</span>, file_name);</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                }</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                num_files++;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;            }</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        }</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="comment">// select current buffer</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="keywordflow">if</span> (i % 2 == 0) {</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            buffer_addr = buffer0;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            buffer_addr = buffer1;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        }</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="comment">// select buffer size</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="keywordflow">if</span> (i &lt; number_buffers - 1 || pru.<a class="code" href="structpru__data__struct.html#a7d58cf74cf96a78347f4a63a5b92b56f">sample_limit</a> % pru.<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a> == 0) {</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            buffer_samples_count = pru.<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a>; <span class="comment">// full buffer size</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            buffer_samples_count =</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                pru.<a class="code" href="structpru__data__struct.html#a7d58cf74cf96a78347f4a63a5b92b56f">sample_limit</a> % pru.<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a>; <span class="comment">// unfull buffer size</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        }</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="comment">// Wait for event completion from PRU</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <span class="comment">// only check for timeout on first buffer (else it does not work!)</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="keywordflow">if</span> (i == 0) {</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="pru_8c.html#a4d0ce3530455f19eaab044e35a461c4f">pru_wait_event_timeout</a>(PRU_EVTOUT_0, <a class="code" href="pru_8h.html#a56f883236138dc4363750263a4739b30">PRU_TIMEOUT</a>) ==</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                ETIMEDOUT) {</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                <span class="comment">// timeout occurred</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a>, <span class="stringliteral">&quot;ADC not responding&quot;</span>);</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;            }</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            prussdrv_pru_wait_event(PRU_EVTOUT_0);</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        }</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="comment">// timestamp received data</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <a class="code" href="util_8c.html#acc2591260361f61f2c83d4b795a1cbe5">create_time_stamp</a>(&amp;timestamp_realtime, &amp;timestamp_monotonic);</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="comment">// adjust time with buffer latency</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        timestamp_realtime.<a class="code" href="structtime__stamp.html#acc8388479ab2df608b5e49c07d757790">nsec</a> -= (uint64_t)1e9 / conf-&gt;update_rate;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        if (timestamp_realtime.<a class="code" href="structtime__stamp.html#acc8388479ab2df608b5e49c07d757790">nsec</a> &lt; 0) {</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            timestamp_realtime.<a class="code" href="structtime__stamp.html#a2d82b3da55b91edc53ecaae2ec523c67">sec</a> -= 1;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            timestamp_realtime.<a class="code" href="structtime__stamp.html#acc8388479ab2df608b5e49c07d757790">nsec</a> += (uint64_t)1e9;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        }</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        timestamp_monotonic.<a class="code" href="structtime__stamp.html#acc8388479ab2df608b5e49c07d757790">nsec</a> -= (uint64_t)1e9 / conf-&gt;update_rate;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        if (timestamp_monotonic.<a class="code" href="structtime__stamp.html#acc8388479ab2df608b5e49c07d757790">nsec</a> &lt; 0) {</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            timestamp_monotonic.<a class="code" href="structtime__stamp.html#a2d82b3da55b91edc53ecaae2ec523c67">sec</a> -= 1;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            timestamp_monotonic.<a class="code" href="structtime__stamp.html#acc8388479ab2df608b5e49c07d757790">nsec</a> += (uint64_t)1e9;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        }</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="comment">// clear event</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        prussdrv_pru_clear_event(PRU_EVTOUT_0, PRU0_ARM_INTERRUPT);</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="comment">// check for overrun (compare buffer numbers)</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        uint32_t buffer_index = *((uint32_t*)buffer_addr);</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        <span class="keywordflow">if</span> (buffer_index != i) {</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;            buffers_lost += (buffer_index - i);</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a984de77c680eaff141ec910e25568a81">WARNING</a>,</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                   <span class="stringliteral">&quot;overrun: %d samples (%d buffer) lost (%d in total)&quot;</span>,</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                   (buffer_index - i) * pru.<a class="code" href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">buffer_size</a>, buffer_index - i,</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                   buffers_lost);</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            i = buffer_index;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        }</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <span class="comment">// handle the buffer</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <a class="code" href="file__handling_8c.html#a8e42c11398fd4a91c318b4436331f6ea">file_handle_data</a>(data_file, buffer_addr + 4, pru.<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a>,</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                         buffer_samples_count, &amp;timestamp_realtime,</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                         &amp;timestamp_monotonic, conf);</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        <span class="comment">// process data for web when enabled</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;enable_web_server == 1) {</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            <a class="code" href="web_8c.html#a5fccb1bdc1d953353b9780edcb1d69be">web_handle_data</a>(web_data, sem_id, buffer_addr + 4, pru.<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a>,</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                            buffer_samples_count, &amp;timestamp_realtime, conf);</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        }</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="comment">// update and write header</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;file_format != <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aaaa33265d2e12fe02833b6564507c7ac2">NO_FILE</a>) {</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            <span class="comment">// update the number of samples stored</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#acb3586e15d269a3b56f34e7e6573c698">data_block_count</a> += 1;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#a9f3346477fae778da2f729566b8998b9">sample_count</a> +=</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                buffer_samples_count / avg_factor;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            <span class="keywordflow">if</span> (conf-&gt;file_format == <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa3dba92f17ebb0d7efe6056d51e9acdc7">BIN</a>) {</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                <a class="code" href="file__handling_8c.html#a951c9a76dbc8ae30a14e95e093a747ce">file_update_header_bin</a>(data_file, &amp;file_header);</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (conf-&gt;file_format == <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa2b10dde645e767164fc3de2ddbf14399">CSV</a>) {</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                <a class="code" href="file__handling_8c.html#a21a2809b6ac3bb4f83e6d9ab2848caac">file_update_header_csv</a>(data_file, &amp;file_header);</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            }</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        }</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="comment">// handle ambient data</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keywordflow">if</span> (skipped_buffers + 1 &gt;= conf-&gt;update_rate) { <span class="comment">// always 1 Sps</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordflow">if</span> (conf-&gt;ambient.enabled == <a class="code" href="types_8h.html#a8e2c970dfb447f044dc6a775cd8d14e4">AMBIENT_ENABLED</a>) {</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                <span class="comment">// fetch and write data</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                <a class="code" href="ambient_8c.html#aec14b4098fe909433983bf3a184ea64f">ambient_store_data</a>(ambient_file, &amp;timestamp_realtime,</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                                   &amp;timestamp_monotonic, conf);</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                <span class="comment">// update and write header</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                ambient_file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#acb3586e15d269a3b56f34e7e6573c698">data_block_count</a> += 1;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                ambient_file_header.<a class="code" href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">lead_in</a>.<a class="code" href="structrl__file__lead__in.html#a9f3346477fae778da2f729566b8998b9">sample_count</a> +=</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                    <a class="code" href="ambient_8h.html#a74a6992665a0891ea1102f0f690faed7">AMBIENT_DATA_BLOCK_SIZE</a>;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                <a class="code" href="file__handling_8c.html#a951c9a76dbc8ae30a14e95e093a747ce">file_update_header_bin</a>(ambient_file, &amp;ambient_file_header);</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            }</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            skipped_buffers = 0;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;            skipped_buffers++;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        }</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="comment">// update and write state</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a480c93843d7a2b194ad898019d1988ee">samples_taken</a> += buffer_samples_count / avg_factor;</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a251c96f085e8e1bf155c5e6494433027">buffer_number</a> = i + 1 - buffers_lost;</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        <a class="code" href="util_8c.html#a3195667ecf2a5a6383a1ea38345ad8ef">write_status</a>(&amp;<a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>);</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        <span class="comment">// notify web clients</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        <span class="comment">// Note: There is a possible race condition here, which might result in</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <span class="comment">// one web client not getting notified once, do we care?</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;enable_web_server == 1) {</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            <span class="keywordtype">int</span> num_web_clients = semctl(sem_id, <a class="code" href="types_8h.html#a52c5783bd4abc9636cfa94b9dc3e1693">WAIT_SEM</a>, GETNCNT);</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;            <a class="code" href="sem_8c.html#ac67b4de40d56892078c0e6156691f578">set_sem</a>(sem_id, <a class="code" href="types_8h.html#a52c5783bd4abc9636cfa94b9dc3e1693">WAIT_SEM</a>, num_web_clients);</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        }</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        <span class="comment">// print meter output</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        <span class="keywordflow">if</span> (conf-&gt;mode == <a class="code" href="types_8h.html#a1a6b6fb557d8d37d59700faf4e4c9167ae2e6be25b55c130066f8efb3490b3826">METER</a>) {</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;            <a class="code" href="meter_8c.html#a5da869f298972c0decf3579a34d5d95e">meter_print_buffer</a>(conf, buffer_addr + 4, pru.<a class="code" href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">sample_size</a>);</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        }</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    }</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="comment">// FILE FINISH (flush)</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;file_format != <a class="code" href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aaaa33265d2e12fe02833b6564507c7ac2">NO_FILE</a> &amp;&amp; <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a89c4d04cc0ca33665db4097e304c90f9">state</a> != <a class="code" href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90aa549f36d05ca9a052a7d97c2f6fc2cea">RL_ERROR</a>) {</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <span class="comment">// print info</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        <a class="code" href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a>(<a class="code" href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a748005382152808a72b1a9177d9dc806">INFO</a>, <span class="stringliteral">&quot;stored %llu samples to file&quot;</span>, <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a480c93843d7a2b194ad898019d1988ee">samples_taken</a>);</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        printf(<span class="stringliteral">&quot;Stored %llu samples to file.\n&quot;</span>, <a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a480c93843d7a2b194ad898019d1988ee">samples_taken</a>);</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        fflush(data_file);</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    }</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    <span class="comment">// PRU FINISH (unmap memory)</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <a class="code" href="pru_8c.html#acc3c091f1563ead66ab59962f3cfdcc5">pru_unmap_memory</a>(buffer0);</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="comment">// WEBSERVER FINISH</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="comment">// unmap shared memory</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;enable_web_server == 1) {</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <a class="code" href="sem_8c.html#adeaa14c9206769c925f50d812c53bf64">remove_sem</a>(sem_id);</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        shmdt(web_data);</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    }</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="comment">// METER FINISH</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="keywordflow">if</span> (conf-&gt;mode == <a class="code" href="types_8h.html#a1a6b6fb557d8d37d59700faf4e4c9167ae2e6be25b55c130066f8efb3490b3826">METER</a>) {</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        <a class="code" href="meter_8c.html#a5e66adf5332d1946c041c2a2b518ad66">meter_stop</a>();</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    }</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="comment">// STATE</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a89c4d04cc0ca33665db4097e304c90f9">state</a> == <a class="code" href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90aa549f36d05ca9a052a7d97c2f6fc2cea">RL_ERROR</a>) {</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a>;</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    }</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;}</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div><div class="line"><a name="l00708"></a><span class="lineno"><a class="line" href="pru_8h.html#ab2cde663e8bad29a264a7670f0e08511">  708</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="pru_8c.html#ab2cde663e8bad29a264a7670f0e08511">pru_stop</a>(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    <span class="comment">// write OFF to PRU state (so PRU can clean up)</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <a class="code" href="pru_8c.html#aca3acbd32d5951672e7b2b1523f3c2fa">pru_set_state</a>(<a class="code" href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077aa1dc6393949d4482ff3e195bd85598f0">PRU_OFF</a>);</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="comment">// wait for interrupt (if no ERROR occured) and clear event</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a>.<a class="code" href="structrl__status.html#a89c4d04cc0ca33665db4097e304c90f9">state</a> != <a class="code" href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90aa549f36d05ca9a052a7d97c2f6fc2cea">RL_ERROR</a>) {</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <a class="code" href="pru_8c.html#a4d0ce3530455f19eaab044e35a461c4f">pru_wait_event_timeout</a>(PRU_EVTOUT_0, <a class="code" href="pru_8h.html#a56f883236138dc4363750263a4739b30">PRU_TIMEOUT</a>);</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        prussdrv_pru_clear_event(PRU_EVTOUT_0, PRU0_ARM_INTERRUPT);</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    }</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;}</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno"><a class="line" href="pru_8h.html#a307dd06bc7b81f70ae57e66aa9a6d2ca">  723</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="pru_8c.html#a307dd06bc7b81f70ae57e66aa9a6d2ca">pru_close</a>(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="comment">// Disable PRU and close memory mappings</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    prussdrv_pru_disable(0);</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    prussdrv_exit();</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;}</div><div class="ttc" id="util_8c_html_a3195667ecf2a5a6383a1ea38345ad8ef"><div class="ttname"><a href="util_8c.html#a3195667ecf2a5a6383a1ea38345ad8ef">write_status</a></div><div class="ttdeci">int write_status(struct rl_status *status)</div><div class="ttdef"><b>Definition:</b> <a href="util_8c_source.html#l00129">util.c:129</a></div></div>
<div class="ttc" id="types_8h_html_a1a6b6fb557d8d37d59700faf4e4c9167ab8c27c7822bc67c502ca70738896680f"><div class="ttname"><a href="types_8h.html#a1a6b6fb557d8d37d59700faf4e4c9167ab8c27c7822bc67c502ca70738896680f">LIMIT</a></div><div class="ttdoc">Limited sampling mode (limited by number of samples to take) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00158">types.h:158</a></div></div>
<div class="ttc" id="structweb__shm_html_a1240d96092b9f4b48e16fa97196216b2"><div class="ttname"><a href="structweb__shm.html#a1240d96092b9f4b48e16fa97196216b2">web_shm::buffer</a></div><div class="ttdeci">struct ringbuffer buffer[WEB_RING_BUFFER_COUNT]</div><div class="ttdoc">Array of ring buffers for different time scales. </div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00101">web.h:101</a></div></div>
<div class="ttc" id="types_8h_html_a3ec7fa75993910b58eeea355257a8a40"><div class="ttname"><a href="types_8h.html#a3ec7fa75993910b58eeea355257a8a40">NUM_DIGITAL_INPUTS</a></div><div class="ttdeci">#define NUM_DIGITAL_INPUTS</div><div class="ttdoc">Number of RocketLogger digital channels. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00110">types.h:110</a></div></div>
<div class="ttc" id="web_8c_html_a9e5e1d279c4b144c577a701cc9528e5f"><div class="ttname"><a href="web_8c.html#a9e5e1d279c4b144c577a701cc9528e5f">web_create_shm</a></div><div class="ttdeci">struct web_shm * web_create_shm(void)</div><div class="ttdef"><b>Definition:</b> <a href="web_8c_source.html#l00047">web.c:47</a></div></div>
<div class="ttc" id="structrl__conf_html_acb73317cb1354c578448512726c6fc2b"><div class="ttname"><a href="structrl__conf.html#acb73317cb1354c578448512726c6fc2b">rl_conf::mode</a></div><div class="ttdeci">rl_mode mode</div><div class="ttdoc">Sampling mode. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00251">types.h:251</a></div></div>
<div class="ttc" id="pru_8h_html_a2d3ec1e69b3e63db5c37c9b0ed6578cf"><div class="ttname"><a href="pru_8h.html#a2d3ec1e69b3e63db5c37c9b0ed6578cf">WREG</a></div><div class="ttdeci">#define WREG</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00082">pru.h:82</a></div></div>
<div class="ttc" id="pru_8c_html_a4707ea56eb19ed66966c1d92567b120c"><div class="ttname"><a href="pru_8c.html#a4707ea56eb19ed66966c1d92567b120c">pru_data_setup</a></div><div class="ttdeci">int pru_data_setup(struct pru_data_struct *pru, struct rl_conf *conf, uint32_t avg_factor)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00189">pru.c:189</a></div></div>
<div class="ttc" id="file__handling_8c_html_a8e42c11398fd4a91c318b4436331f6ea"><div class="ttname"><a href="file__handling_8c.html#a8e42c11398fd4a91c318b4436331f6ea">file_handle_data</a></div><div class="ttdeci">void file_handle_data(FILE *data_file, void *buffer_addr, uint32_t sample_data_size, uint32_t samples_count, struct time_stamp *timestamp_realtime, struct time_stamp *timestamp_monotonic, struct rl_conf *conf)</div><div class="ttdef"><b>Definition:</b> <a href="file__handling_8c_source.html#l00364">file_handling.c:364</a></div></div>
<div class="ttc" id="pru_8h_html_a9986bad57c98d8a0d316444fc66de053"><div class="ttname"><a href="pru_8h.html#a9986bad57c98d8a0d316444fc66de053">PRECISION_LOW</a></div><div class="ttdeci">#define PRECISION_LOW</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00139">pru.h:139</a></div></div>
<div class="ttc" id="file__handling_8c_html_aa09c799f4b81e3b8ca5f08ac651a4b4e"><div class="ttname"><a href="file__handling_8c.html#aa09c799f4b81e3b8ca5f08ac651a4b4e">file_store_header_bin</a></div><div class="ttdeci">void file_store_header_bin(FILE *data_file, struct rl_file_header *file_header)</div><div class="ttdef"><b>Definition:</b> <a href="file__handling_8c_source.html#l00205">file_handling.c:205</a></div></div>
<div class="ttc" id="types_8h_html_a6d58f9ac447476b4e084d7ca383f5183"><div class="ttname"><a href="types_8h.html#a6d58f9ac447476b4e084d7ca383f5183">FAILURE</a></div><div class="ttdeci">#define FAILURE</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00078">types.h:78</a></div></div>
<div class="ttc" id="types_8h_html_aa90cac659d18e8ef6294c7ae337f6b58"><div class="ttname"><a href="types_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a></div><div class="ttdeci">#define SUCCESS</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00075">types.h:75</a></div></div>
<div class="ttc" id="file__handling_8c_html_a951c9a76dbc8ae30a14e95e093a747ce"><div class="ttname"><a href="file__handling_8c.html#a951c9a76dbc8ae30a14e95e093a747ce">file_update_header_bin</a></div><div class="ttdeci">void file_update_header_bin(FILE *data_file, struct rl_file_header *file_header)</div><div class="ttdef"><b>Definition:</b> <a href="file__handling_8c_source.html#l00321">file_handling.c:321</a></div></div>
<div class="ttc" id="structrl__file__header_html_a71700ed3b946a3d117b8c047c9b4af36"><div class="ttname"><a href="structrl__file__header.html#a71700ed3b946a3d117b8c047c9b4af36">rl_file_header::lead_in</a></div><div class="ttdeci">struct rl_file_lead_in lead_in</div><div class="ttdoc">File header lead in (constant size) </div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00165">rl_file.h:165</a></div></div>
<div class="ttc" id="meter_8c_html_a5da869f298972c0decf3579a34d5d95e"><div class="ttname"><a href="meter_8c.html#a5da869f298972c0decf3579a34d5d95e">meter_print_buffer</a></div><div class="ttdeci">void meter_print_buffer(struct rl_conf *conf, void *buffer_addr, uint32_t sample_size)</div><div class="ttdef"><b>Definition:</b> <a href="meter_8c_source.html#l00068">meter.c:68</a></div></div>
<div class="ttc" id="types_8h_html_abd81d11867ad50357ea8332e8d36cf8aa2b10dde645e767164fc3de2ddbf14399"><div class="ttname"><a href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa2b10dde645e767164fc3de2ddbf14399">CSV</a></div><div class="ttdoc">CSV format. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00184">types.h:184</a></div></div>
<div class="ttc" id="structpru__data__struct_html_a9a124ab5c8c3af75e1ab43b678a2b211"><div class="ttname"><a href="structpru__data__struct.html#a9a124ab5c8c3af75e1ab43b678a2b211">pru_data_struct::state</a></div><div class="ttdeci">rl_pru_state state</div><div class="ttdoc">Current PRU state. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00172">pru.h:172</a></div></div>
<div class="ttc" id="rl__server_8c_html_aa8969b0084c456770fefa53f075d7c7f"><div class="ttname"><a href="rl__server_8c.html#aa8969b0084c456770fefa53f075d7c7f">status</a></div><div class="ttdeci">struct rl_status status</div><div class="ttdoc">Current status of RocketLogger. </div><div class="ttdef"><b>Definition:</b> <a href="rl__server_8c_source.html#l00071">rl_server.c:71</a></div></div>
<div class="ttc" id="structtime__stamp_html_a2d82b3da55b91edc53ecaae2ec523c67"><div class="ttname"><a href="structtime__stamp.html#a2d82b3da55b91edc53ecaae2ec523c67">time_stamp::sec</a></div><div class="ttdeci">int64_t sec</div><div class="ttdoc">Seconds in UNIX time (UTC) </div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00047">util.h:47</a></div></div>
<div class="ttc" id="web_8h_html_aded994583757000c85dd518823c5ac1b"><div class="ttname"><a href="web_8h.html#aded994583757000c85dd518823c5ac1b">BUFFER1_SIZE</a></div><div class="ttdeci">#define BUFFER1_SIZE</div><div class="ttdoc">Size of 1s/div buffer. </div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00060">web.h:60</a></div></div>
<div class="ttc" id="pru_8h_html_aae10ea86a4b725e7fe6149829a9a0004"><div class="ttname"><a href="pru_8h.html#aae10ea86a4b725e7fe6149829a9a0004">RDATAC</a></div><div class="ttdeci">#define RDATAC</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00078">pru.h:78</a></div></div>
<div class="ttc" id="structrl__file__channel_html"><div class="ttname"><a href="structrl__file__channel.html">rl_file_channel</a></div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00141">rl_file.h:141</a></div></div>
<div class="ttc" id="web_8h_html_a61ac01a77bd9c1074fa93bd1a099f010"><div class="ttname"><a href="web_8h.html#a61ac01a77bd9c1074fa93bd1a099f010">NUM_WEB_POINTS</a></div><div class="ttdeci">#define NUM_WEB_POINTS</div><div class="ttdoc">Number of data points in web plot. </div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00069">web.h:69</a></div></div>
<div class="ttc" id="pru_8c_html_af73086371d580a3406c0aaa73420ade2"><div class="ttname"><a href="pru_8c.html#af73086371d580a3406c0aaa73420ade2">pru_map_memory</a></div><div class="ttdeci">void * pru_map_memory(void)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00106">pru.c:106</a></div></div>
<div class="ttc" id="pru_8h_html_a9a4bd57068f054cec3fd02dbc65d2f5d"><div class="ttname"><a href="pru_8h.html#a9a4bd57068f054cec3fd02dbc65d2f5d">K64</a></div><div class="ttdeci">#define K64</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00116">pru.h:116</a></div></div>
<div class="ttc" id="pru_8h_html_a07a6f4f9ee069b2323f2fccafe018bd8"><div class="ttname"><a href="pru_8h.html#a07a6f4f9ee069b2323f2fccafe018bd8">NUMBER_ADC_COMMANDS</a></div><div class="ttdeci">#define NUMBER_ADC_COMMANDS</div><div class="ttdoc">Number of ADC commands. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00165">pru.h:165</a></div></div>
<div class="ttc" id="types_8h_html_a21618178aad39fdcaf3152756081362d"><div class="ttname"><a href="types_8h.html#a21618178aad39fdcaf3152756081362d">NUM_SEMS</a></div><div class="ttdeci">#define NUM_SEMS</div><div class="ttdoc">Number of semaphores in set. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00314">types.h:314</a></div></div>
<div class="ttc" id="ambient_8h_html_a74a6992665a0891ea1102f0f690faed7"><div class="ttname"><a href="ambient_8h.html#a74a6992665a0891ea1102f0f690faed7">AMBIENT_DATA_BLOCK_SIZE</a></div><div class="ttdeci">#define AMBIENT_DATA_BLOCK_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="ambient_8h_source.html#l00043">ambient.h:43</a></div></div>
<div class="ttc" id="types_8h_html_a52c5783bd4abc9636cfa94b9dc3e1693"><div class="ttname"><a href="types_8h.html#a52c5783bd4abc9636cfa94b9dc3e1693">WAIT_SEM</a></div><div class="ttdeci">#define WAIT_SEM</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00326">types.h:326</a></div></div>
<div class="ttc" id="ambient_8c_html_a40f29e027672a26cb7a136af8635b775"><div class="ttname"><a href="ambient_8c.html#a40f29e027672a26cb7a136af8635b775">ambient_setup_lead_in</a></div><div class="ttdeci">void ambient_setup_lead_in(struct rl_file_lead_in *lead_in, struct rl_conf *conf)</div><div class="ttdef"><b>Definition:</b> <a href="ambient_8c_source.html#l00101">ambient.c:101</a></div></div>
<div class="ttc" id="log_8c_html_a03a4554bb48a96130b86f2c14b23f515"><div class="ttname"><a href="log_8c.html#a03a4554bb48a96130b86f2c14b23f515">rl_log</a></div><div class="ttdeci">void rl_log(rl_log_type type, const char *format,...)</div><div class="ttdef"><b>Definition:</b> <a href="log_8c_source.html#l00039">log.c:39</a></div></div>
<div class="ttc" id="pru_8h_html_a3c2a19f5e92f0c34ae9c541000cf72e9"><div class="ttname"><a href="pru_8h.html#a3c2a19f5e92f0c34ae9c541000cf72e9">CONFIG1DEFAULT</a></div><div class="ttdeci">#define CONFIG1DEFAULT</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00121">pru.h:121</a></div></div>
<div class="ttc" id="pru_8h_html_ad3d8f27a31684427b780e4d6466fd2a3"><div class="ttname"><a href="pru_8h.html#ad3d8f27a31684427b780e4d6466fd2a3">K32</a></div><div class="ttdeci">#define K32</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00115">pru.h:115</a></div></div>
<div class="ttc" id="types_8h_html_a299ffb74b818be524ba85f23e7978906"><div class="ttname"><a href="types_8h.html#a299ffb74b818be524ba85f23e7978906">SEM_KEY</a></div><div class="ttdeci">#define SEM_KEY</div><div class="ttdoc">Semaphore key (used for set creation) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00312">types.h:312</a></div></div>
<div class="ttc" id="util_8c_html_a67a3cc56d4440aca0b206f54add44ee2"><div class="ttname"><a href="util_8c.html#a67a3cc56d4440aca0b206f54add44ee2">read_file_value</a></div><div class="ttdeci">int read_file_value(char filename[])</div><div class="ttdef"><b>Definition:</b> <a href="util_8c_source.html#l00202">util.c:202</a></div></div>
<div class="ttc" id="meter_8c_html_aad154a6600f07718dd4c981eff256b9a"><div class="ttname"><a href="meter_8c.html#aad154a6600f07718dd4c981eff256b9a">meter_init</a></div><div class="ttdeci">void meter_init(void)</div><div class="ttdef"><b>Definition:</b> <a href="meter_8c_source.html#l00047">meter.c:47</a></div></div>
<div class="ttc" id="pru_8h_html_a56f883236138dc4363750263a4739b30"><div class="ttname"><a href="pru_8h.html#a56f883236138dc4363750263a4739b30">PRU_TIMEOUT</a></div><div class="ttdeci">#define PRU_TIMEOUT</div><div class="ttdoc">PRU time out in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00153">pru.h:153</a></div></div>
<div class="ttc" id="web_8h_html_a85839eeebbf105029b459c112ca62fe1"><div class="ttname"><a href="web_8h.html#a85839eeebbf105029b459c112ca62fe1">BUFFER10_SIZE</a></div><div class="ttdeci">#define BUFFER10_SIZE</div><div class="ttdoc">Size of 10s/div buffer. </div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00062">web.h:62</a></div></div>
<div class="ttc" id="sem_8c_html_ac67b4de40d56892078c0e6156691f578"><div class="ttname"><a href="sem_8c.html#ac67b4de40d56892078c0e6156691f578">set_sem</a></div><div class="ttdeci">int set_sem(int sem_id, int sem_num, int val)</div><div class="ttdef"><b>Definition:</b> <a href="sem_8c_source.html#l00124">sem.c:124</a></div></div>
<div class="ttc" id="pru_8h_html_aadecb1977e30da2f62766f1fcb8b1f95"><div class="ttname"><a href="pru_8h.html#aadecb1977e30da2f62766f1fcb8b1f95">K1</a></div><div class="ttdeci">#define K1</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00110">pru.h:110</a></div></div>
<div class="ttc" id="structweb__shm_html_a77b5891b6761d7f5763e9cde2ed73dbd"><div class="ttname"><a href="structweb__shm.html#a77b5891b6761d7f5763e9cde2ed73dbd">web_shm::num_channels</a></div><div class="ttdeci">uint32_t num_channels</div><div class="ttdoc">Number of channels sampled. </div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00099">web.h:99</a></div></div>
<div class="ttc" id="pru_8h_html_ac1d7cd733ef08a5dde1d84664788bfa5"><div class="ttname"><a href="pru_8h.html#ac1d7cd733ef08a5dde1d84664788bfa5">rl_pru_state</a></div><div class="ttdeci">enum pru_state rl_pru_state</div></div>
<div class="ttc" id="util_8c_html_a04f4c5f21d5257f6b867ec19c6988156"><div class="ttname"><a href="util_8c.html#a04f4c5f21d5257f6b867ec19c6988156">ceil_div</a></div><div class="ttdeci">int ceil_div(int n, int d)</div><div class="ttdef"><b>Definition:</b> <a href="util_8c_source.html#l00164">util.c:164</a></div></div>
<div class="ttc" id="file__handling_8h_html"><div class="ttname"><a href="file__handling_8h.html">file_handling.h</a></div></div>
<div class="ttc" id="pru_8h_html_a20a140ced2d12dab5beb039c3bd78077a1b1bd13d3255a25810bfe9328cb00f33"><div class="ttname"><a href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077a1b1bd13d3255a25810bfe9328cb00f33">PRU_LIMIT</a></div><div class="ttdoc">Limited sampling mode. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00160">pru.h:160</a></div></div>
<div class="ttc" id="structrl__file__header_html_a1aecd54363b81500f412b50cb2d5f2f5"><div class="ttname"><a href="structrl__file__header.html#a1aecd54363b81500f412b50cb2d5f2f5">rl_file_header::channel</a></div><div class="ttdeci">struct rl_file_channel * channel</div><div class="ttdoc">Channels definitions (binary and normal) </div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00171">rl_file.h:171</a></div></div>
<div class="ttc" id="pru_8h_html_ae4549ec8ad2b570fc4a3cce6a53c086a"><div class="ttname"><a href="pru_8h.html#ae4549ec8ad2b570fc4a3cce6a53c086a">GAIN1</a></div><div class="ttdeci">#define GAIN1</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00103">pru.h:103</a></div></div>
<div class="ttc" id="structrl__conf_html_a9c750f476bb28805f6e4c642060e6c26"><div class="ttname"><a href="structrl__conf.html#a9c750f476bb28805f6e4c642060e6c26">rl_conf::digital_inputs</a></div><div class="ttdeci">int digital_inputs</div><div class="ttdoc">En-/disable digital inputs. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00265">types.h:265</a></div></div>
<div class="ttc" id="types_8h_html_a9eb6992d76f02128388ae95c0415604a"><div class="ttname"><a href="types_8h.html#a9eb6992d76f02128388ae95c0415604a">MAX_PATH_LENGTH</a></div><div class="ttdeci">#define MAX_PATH_LENGTH</div><div class="ttdoc">Maximum path length in characters. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00102">types.h:102</a></div></div>
<div class="ttc" id="structrl__file__lead__in_html_a9f3346477fae778da2f729566b8998b9"><div class="ttname"><a href="structrl__file__lead__in.html#a9f3346477fae778da2f729566b8998b9">rl_file_lead_in::sample_count</a></div><div class="ttdeci">uint64_t sample_count</div><div class="ttdoc">Total sample count. </div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00117">rl_file.h:117</a></div></div>
<div class="ttc" id="ambient_8c_html_ab77fe35d0811fec079d975b6e7534cc8"><div class="ttname"><a href="ambient_8c.html#ab77fe35d0811fec079d975b6e7534cc8">ambient_setup_header</a></div><div class="ttdeci">void ambient_setup_header(struct rl_file_header *file_header, struct rl_conf *conf, char *comment)</div><div class="ttdef"><b>Definition:</b> <a href="ambient_8c_source.html#l00160">ambient.c:160</a></div></div>
<div class="ttc" id="structrl__file__lead__in_html_af92f62ea3f9a70862630a84b31e97482"><div class="ttname"><a href="structrl__file__lead__in.html#af92f62ea3f9a70862630a84b31e97482">rl_file_lead_in::channel_bin_count</a></div><div class="ttdeci">uint16_t channel_bin_count</div><div class="ttdoc">Binary channel count. </div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00132">rl_file.h:132</a></div></div>
<div class="ttc" id="file__handling_8c_html_a1f114cf1836475c8a1d2101c7f62ff23"><div class="ttname"><a href="file__handling_8c.html#a1f114cf1836475c8a1d2101c7f62ff23">file_setup_header</a></div><div class="ttdeci">void file_setup_header(struct rl_file_header *file_header, struct rl_conf *conf, char *comment)</div><div class="ttdef"><b>Definition:</b> <a href="file__handling_8c_source.html#l00186">file_handling.c:186</a></div></div>
<div class="ttc" id="pru_8h_html_a82da5e0788cd6c3833dc14640c2486d6"><div class="ttname"><a href="pru_8h.html#a82da5e0788cd6c3833dc14640c2486d6">PRECISION_HIGH</a></div><div class="ttdeci">#define PRECISION_HIGH</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00138">pru.h:138</a></div></div>
<div class="ttc" id="structrl__conf_html_a1c3f8925c62557844a0db974c5cffeaf"><div class="ttname"><a href="structrl__conf.html#a1c3f8925c62557844a0db974c5cffeaf">rl_conf::enable_web_server</a></div><div class="ttdeci">int enable_web_server</div><div class="ttdoc">En-/disable plots on web interface. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00267">types.h:267</a></div></div>
<div class="ttc" id="pru_8h_html_a1dd039bdaf032f25ea184090c794f22f"><div class="ttname"><a href="pru_8h.html#a1dd039bdaf032f25ea184090c794f22f">PRU_CODE</a></div><div class="ttdeci">#define PRU_CODE</div><div class="ttdoc">PRU binary file location. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00130">pru.h:130</a></div></div>
<div class="ttc" id="file__handling_8c_html_a21a2809b6ac3bb4f83e6d9ab2848caac"><div class="ttname"><a href="file__handling_8c.html#a21a2809b6ac3bb4f83e6d9ab2848caac">file_update_header_csv</a></div><div class="ttdeci">void file_update_header_csv(FILE *data_file, struct rl_file_header *file_header)</div><div class="ttdef"><b>Definition:</b> <a href="file__handling_8c_source.html#l00338">file_handling.c:338</a></div></div>
<div class="ttc" id="file__handling_8c_html_a3b344b69b354ebdf3cf8d8735de3d935"><div class="ttname"><a href="file__handling_8c.html#a3b344b69b354ebdf3cf8d8735de3d935">file_setup_lead_in</a></div><div class="ttdeci">void file_setup_lead_in(struct rl_file_lead_in *lead_in, struct rl_conf *conf)</div><div class="ttdef"><b>Definition:</b> <a href="file__handling_8c_source.html#l00060">file_handling.c:60</a></div></div>
<div class="ttc" id="pru_8h_html_a0d9979e6e1d8b4e7727063b2660ac10b"><div class="ttname"><a href="pru_8h.html#a0d9979e6e1d8b4e7727063b2660ac10b">CH4SET</a></div><div class="ttdeci">#define CH4SET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00094">pru.h:94</a></div></div>
<div class="ttc" id="rl__server_8c_html_a9825b926ad2a4aa0e6688dc15b2d9a23"><div class="ttname"><a href="rl__server_8c.html#a9825b926ad2a4aa0e6688dc15b2d9a23">sem_id</a></div><div class="ttdeci">int sem_id</div><div class="ttdoc">ID of semaphore set. </div><div class="ttdef"><b>Definition:</b> <a href="rl__server_8c_source.html#l00053">rl_server.c:53</a></div></div>
<div class="ttc" id="types_8h_html_abd81d11867ad50357ea8332e8d36cf8aa3dba92f17ebb0d7efe6056d51e9acdc7"><div class="ttname"><a href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aa3dba92f17ebb0d7efe6056d51e9acdc7">BIN</a></div><div class="ttdoc">Binary format. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00185">types.h:185</a></div></div>
<div class="ttc" id="structtime__stamp_html"><div class="ttname"><a href="structtime__stamp.html">time_stamp</a></div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00045">util.h:45</a></div></div>
<div class="ttc" id="types_8h_html_a0c5903cbca2638009928b86b57e223c1"><div class="ttname"><a href="types_8h.html#a0c5903cbca2638009928b86b57e223c1">DATA_SEM</a></div><div class="ttdeci">#define DATA_SEM</div><div class="ttdoc">Number of data semaphore in set (manages access to shared memory data) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00323">types.h:323</a></div></div>
<div class="ttc" id="structrl__status_html_a89c4d04cc0ca33665db4097e304c90f9"><div class="ttname"><a href="structrl__status.html#a89c4d04cc0ca33665db4097e304c90f9">rl_status::state</a></div><div class="ttdeci">rl_state state</div><div class="ttdoc">State. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00285">types.h:285</a></div></div>
<div class="ttc" id="pru_8h_html_a20a140ced2d12dab5beb039c3bd78077a126d7c453b951c98cc537ef0a69082a5"><div class="ttname"><a href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077a126d7c453b951c98cc537ef0a69082a5">PRU_CONTINUOUS</a></div><div class="ttdoc">Continuous sampling mode. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00161">pru.h:161</a></div></div>
<div class="ttc" id="sem_8c_html_a51ff2c8ef965d91bf86b978f6a7f1e1e"><div class="ttname"><a href="sem_8c.html#a51ff2c8ef965d91bf86b978f6a7f1e1e">create_sem</a></div><div class="ttdeci">int create_sem(key_t key, int num_sems)</div><div class="ttdef"><b>Definition:</b> <a href="sem_8c_source.html#l00046">sem.c:46</a></div></div>
<div class="ttc" id="structrl__status_html_a480c93843d7a2b194ad898019d1988ee"><div class="ttname"><a href="structrl__status.html#a480c93843d7a2b194ad898019d1988ee">rl_status::samples_taken</a></div><div class="ttdeci">uint64_t samples_taken</div><div class="ttdoc">Number of samples taken. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00289">types.h:289</a></div></div>
<div class="ttc" id="types_8h_html_a53020ec87954ae4e18c451f4fbecbb5e"><div class="ttname"><a href="types_8h.html#a53020ec87954ae4e18c451f4fbecbb5e">I2L_INDEX</a></div><div class="ttdeci">#define I2L_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00234">types.h:234</a></div></div>
<div class="ttc" id="pru_8h_html_ae28dbf424985dc1c58ae7dbc5a0926b9"><div class="ttname"><a href="pru_8h.html#ae28dbf424985dc1c58ae7dbc5a0926b9">CONFIG1</a></div><div class="ttdeci">#define CONFIG1</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00088">pru.h:88</a></div></div>
<div class="ttc" id="types_8h_html_adc6e5733fc3c22f0a7b2914188c49c90"><div class="ttname"><a href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a></div><div class="ttdeci">state</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00140">types.h:140</a></div></div>
<div class="ttc" id="web_8h_html"><div class="ttname"><a href="web_8h.html">web.h</a></div></div>
<div class="ttc" id="sem_8c_html_adeaa14c9206769c925f50d812c53bf64"><div class="ttname"><a href="sem_8c.html#adeaa14c9206769c925f50d812c53bf64">remove_sem</a></div><div class="ttdeci">int remove_sem(int sem_id)</div><div class="ttdef"><b>Definition:</b> <a href="sem_8c_source.html#l00059">sem.c:59</a></div></div>
<div class="ttc" id="rl__server_8c_html_ac78ce7090cafb1d77cebd9711187f2e4"><div class="ttname"><a href="rl__server_8c.html#ac78ce7090cafb1d77cebd9711187f2e4">web_data</a></div><div class="ttdeci">struct web_shm * web_data</div><div class="ttdoc">Pointer to shared memory data. </div><div class="ttdef"><b>Definition:</b> <a href="rl__server_8c_source.html#l00055">rl_server.c:55</a></div></div>
<div class="ttc" id="web_8c_html_a35b6ae887b599672cf637a293003aed9"><div class="ttname"><a href="web_8c.html#a35b6ae887b599672cf637a293003aed9">web_buffer_reset</a></div><div class="ttdeci">void web_buffer_reset(struct ringbuffer *buffer, int element_size, int length)</div><div class="ttdef"><b>Definition:</b> <a href="web_8c_source.html#l00101">web.c:101</a></div></div>
<div class="ttc" id="structpru__data__struct_html_ad74d154a959da4d358bb969605af3604"><div class="ttname"><a href="structpru__data__struct.html#ad74d154a959da4d358bb969605af3604">pru_data_struct::buffer_size</a></div><div class="ttdeci">uint32_t buffer_size</div><div class="ttdoc">Shared buffer size. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00182">pru.h:182</a></div></div>
<div class="ttc" id="structrl__conf_html_aed527641b352701ced22fb0b97a549d0"><div class="ttname"><a href="structrl__conf.html#aed527641b352701ced22fb0b97a549d0">rl_conf::sample_limit</a></div><div class="ttdeci">int sample_limit</div><div class="ttdoc">Sample limit (0 for continuous) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00259">types.h:259</a></div></div>
<div class="ttc" id="structrl__conf_html"><div class="ttname"><a href="structrl__conf.html">rl_conf</a></div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00247">types.h:247</a></div></div>
<div class="ttc" id="types_8h_html_ae5597ce31d23d11493e6e674fe257d73"><div class="ttname"><a href="types_8h.html#ae5597ce31d23d11493e6e674fe257d73">NUM_CHANNELS</a></div><div class="ttdeci">#define NUM_CHANNELS</div><div class="ttdoc">Maximum number of RocketLogger channels. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00104">types.h:104</a></div></div>
<div class="ttc" id="types_8h_html_ae4df85c08e7e08883c9bd1ffb4cd78ca"><div class="ttname"><a href="types_8h.html#ae4df85c08e7e08883c9bd1ffb4cd78ca">CHANNEL_ENABLED</a></div><div class="ttdeci">#define CHANNEL_ENABLED</div><div class="ttdoc">Channel sampling enabled. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00223">types.h:223</a></div></div>
<div class="ttc" id="types_8h_html_a8488e4c6d9298df81f48a34e80c81410a984de77c680eaff141ec910e25568a81"><div class="ttname"><a href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a984de77c680eaff141ec910e25568a81">WARNING</a></div><div class="ttdoc">Warning. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00201">types.h:201</a></div></div>
<div class="ttc" id="pru_8h_html_a3e8ab2c505cc6f00a1807a151a9ebcdb"><div class="ttname"><a href="pru_8h.html#a3e8ab2c505cc6f00a1807a151a9ebcdb">CH2SET</a></div><div class="ttdeci">#define CH2SET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00092">pru.h:92</a></div></div>
<div class="ttc" id="pru_8h_html_a8d128687074c874210b0c9dada3d8ca7"><div class="ttname"><a href="pru_8h.html#a8d128687074c874210b0c9dada3d8ca7">CONFIG3</a></div><div class="ttdeci">#define CONFIG3</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00090">pru.h:90</a></div></div>
<div class="ttc" id="structpru__data__struct_html_a9b2b63675bd287b19168db44db53583c"><div class="ttname"><a href="structpru__data__struct.html#a9b2b63675bd287b19168db44db53583c">pru_data_struct::number_commands</a></div><div class="ttdeci">uint32_t number_commands</div><div class="ttdoc">Number of ADC commands to send. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00186">pru.h:186</a></div></div>
<div class="ttc" id="structrl__file__header_html"><div class="ttname"><a href="structrl__file__header.html">rl_file_header</a></div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00162">rl_file.h:162</a></div></div>
<div class="ttc" id="web_8h_html_a7484e405104d2f62234131755669185c"><div class="ttname"><a href="web_8h.html#a7484e405104d2f62234131755669185c">BUFFER100_SIZE</a></div><div class="ttdeci">#define BUFFER100_SIZE</div><div class="ttdoc">Size of 100s/div buffer. </div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00064">web.h:64</a></div></div>
<div class="ttc" id="types_8h_html_a08aa59d6c1bdc9cf2882727937263665"><div class="ttname"><a href="types_8h.html#a08aa59d6c1bdc9cf2882727937263665">I1H_INDEX</a></div><div class="ttdeci">#define I1H_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00229">types.h:229</a></div></div>
<div class="ttc" id="types_8h_html_ad7ee97d57258ec2cb4278dba11dcf393"><div class="ttname"><a href="types_8h.html#ad7ee97d57258ec2cb4278dba11dcf393">PRU_DIG_SIZE</a></div><div class="ttdeci">#define PRU_DIG_SIZE</div><div class="ttdoc">Size of PRU digital information in bytes. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00114">types.h:114</a></div></div>
<div class="ttc" id="pru_8h_html_a05874079216c802a325d9f7251b6e6d8"><div class="ttname"><a href="pru_8h.html#a05874079216c802a325d9f7251b6e6d8">CONFIG3DEFAULT</a></div><div class="ttdeci">#define CONFIG3DEFAULT</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00123">pru.h:123</a></div></div>
<div class="ttc" id="structpru__data__struct_html_a7d58cf74cf96a78347f4a63a5b92b56f"><div class="ttname"><a href="structpru__data__struct.html#a7d58cf74cf96a78347f4a63a5b92b56f">pru_data_struct::sample_limit</a></div><div class="ttdeci">uint32_t sample_limit</div><div class="ttdoc">Samples to take (0 for continuous) </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00184">pru.h:184</a></div></div>
<div class="ttc" id="util_8c_html_acc2591260361f61f2c83d4b795a1cbe5"><div class="ttname"><a href="util_8c.html#acc2591260361f61f2c83d4b795a1cbe5">create_time_stamp</a></div><div class="ttdeci">void create_time_stamp(struct time_stamp *timestamp_realtime, struct time_stamp *timestamp_monotonic)</div><div class="ttdef"><b>Definition:</b> <a href="util_8c_source.html#l00223">util.c:223</a></div></div>
<div class="ttc" id="web_8c_html_a5fccb1bdc1d953353b9780edcb1d69be"><div class="ttname"><a href="web_8c.html#a5fccb1bdc1d953353b9780edcb1d69be">web_handle_data</a></div><div class="ttdeci">void web_handle_data(struct web_shm *web_data_ptr, int sem_id, void *buffer_addr, uint32_t sample_data_size, uint32_t samples_count, struct time_stamp *timestamp_realtime, struct rl_conf *conf)</div><div class="ttdef"><b>Definition:</b> <a href="web_8c_source.html#l00201">web.c:201</a></div></div>
<div class="ttc" id="pru_8h_html_a70dccc80e613cfc0eea471983aecc229"><div class="ttname"><a href="pru_8h.html#a70dccc80e613cfc0eea471983aecc229">CH3SET</a></div><div class="ttdeci">#define CH3SET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00093">pru.h:93</a></div></div>
<div class="ttc" id="types_8h_html_adc6e5733fc3c22f0a7b2914188c49c90a667912439842b69502b5534c329bf9fa"><div class="ttname"><a href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90a667912439842b69502b5534c329bf9fa">RL_RUNNING</a></div><div class="ttdoc">Running. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00142">types.h:142</a></div></div>
<div class="ttc" id="util_8h_html"><div class="ttname"><a href="util_8h.html">util.h</a></div></div>
<div class="ttc" id="structrl__conf_html_a1bb42e09a4f26c8539c8e56961adbd46"><div class="ttname"><a href="structrl__conf.html#a1bb42e09a4f26c8539c8e56961adbd46">rl_conf::channels</a></div><div class="ttdeci">int channels[NUM_CHANNELS]</div><div class="ttdoc">Channels to sample. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00261">types.h:261</a></div></div>
<div class="ttc" id="pru_8h_html_ab6d0e745059aded06587e4b6933bca0b"><div class="ttname"><a href="pru_8h.html#ab6d0e745059aded06587e4b6933bca0b">K2</a></div><div class="ttdeci">#define K2</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00111">pru.h:111</a></div></div>
<div class="ttc" id="pru_8h_html_a66a8e71a3df40b69d3a5483c3cd972e0"><div class="ttname"><a href="pru_8h.html#a66a8e71a3df40b69d3a5483c3cd972e0">K8</a></div><div class="ttdeci">#define K8</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00113">pru.h:113</a></div></div>
<div class="ttc" id="structrl__file__lead__in_html_aa2cb152a2f9b5b6cc52f7e49c06ed199"><div class="ttname"><a href="structrl__file__lead__in.html#aa2cb152a2f9b5b6cc52f7e49c06ed199">rl_file_lead_in::channel_count</a></div><div class="ttdeci">uint16_t channel_count</div><div class="ttdoc">Analog channel count. </div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00135">rl_file.h:135</a></div></div>
<div class="ttc" id="file__handling_8c_html_a0e1af80ad5108aa7d82d65692ebb716d"><div class="ttname"><a href="file__handling_8c.html#a0e1af80ad5108aa7d82d65692ebb716d">file_store_header_csv</a></div><div class="ttdeci">void file_store_header_csv(FILE *data_file, struct rl_file_header *file_header)</div><div class="ttdef"><b>Definition:</b> <a href="file__handling_8c_source.html#l00248">file_handling.c:248</a></div></div>
<div class="ttc" id="pru_8h_html_aff7800e91abe1001d9e3c9febc34e0d3"><div class="ttname"><a href="pru_8h.html#aff7800e91abe1001d9e3c9febc34e0d3">CH5SET</a></div><div class="ttdeci">#define CH5SET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00095">pru.h:95</a></div></div>
<div class="ttc" id="types_8h_html_a6313dcd0bf77984a880d87a36d409082"><div class="ttname"><a href="types_8h.html#a6313dcd0bf77984a880d87a36d409082">PRU_BUFFER_STATUS_SIZE</a></div><div class="ttdeci">#define PRU_BUFFER_STATUS_SIZE</div><div class="ttdoc">Size of PRU buffer status in bytes. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00116">types.h:116</a></div></div>
<div class="ttc" id="ambient_8c_html_aec14b4098fe909433983bf3a184ea64f"><div class="ttname"><a href="ambient_8c.html#aec14b4098fe909433983bf3a184ea64f">ambient_store_data</a></div><div class="ttdeci">void ambient_store_data(FILE *ambient_file, struct time_stamp *timestamp_realtime, struct time_stamp *timestamp_monotonic, struct rl_conf *conf)</div><div class="ttdef"><b>Definition:</b> <a href="ambient_8c_source.html#l00043">ambient.c:43</a></div></div>
<div class="ttc" id="structrl__conf_html_ae6a5bf7b6cf3b25bb50fe92c5d322811"><div class="ttname"><a href="structrl__conf.html#ae6a5bf7b6cf3b25bb50fe92c5d322811">rl_conf::file_format</a></div><div class="ttdeci">rl_file_format file_format</div><div class="ttdoc">File format. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00271">types.h:271</a></div></div>
<div class="ttc" id="structrl__status_html_a251c96f085e8e1bf155c5e6494433027"><div class="ttname"><a href="structrl__status.html#a251c96f085e8e1bf155c5e6494433027">rl_status::buffer_number</a></div><div class="ttdeci">uint32_t buffer_number</div><div class="ttdoc">Number of buffers taken. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00291">types.h:291</a></div></div>
<div class="ttc" id="web_8h_html_adff06b81f16f93135a073319feae1be3"><div class="ttname"><a href="web_8h.html#adff06b81f16f93135a073319feae1be3">WEB_RING_BUFFER_COUNT</a></div><div class="ttdeci">#define WEB_RING_BUFFER_COUNT</div><div class="ttdoc">Number of ring buffers in shared memory. </div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00042">web.h:42</a></div></div>
<div class="ttc" id="structpru__data__struct_html_a5e49060cde0f78e51f4c2a1eaf46fd01"><div class="ttname"><a href="structpru__data__struct.html#a5e49060cde0f78e51f4c2a1eaf46fd01">pru_data_struct::sample_size</a></div><div class="ttdeci">uint32_t sample_size</div><div class="ttdoc">Sample size in shared memory. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00176">pru.h:176</a></div></div>
<div class="ttc" id="structrl__conf_html_afd4e6a8ccbb7b43ce6a48f347c6c496d"><div class="ttname"><a href="structrl__conf.html#afd4e6a8ccbb7b43ce6a48f347c6c496d">rl_conf::update_rate</a></div><div class="ttdeci">int update_rate</div><div class="ttdoc">Data update rate. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00257">types.h:257</a></div></div>
<div class="ttc" id="pru_8c_html_ab2cde663e8bad29a264a7670f0e08511"><div class="ttname"><a href="pru_8c.html#ab2cde663e8bad29a264a7670f0e08511">pru_stop</a></div><div class="ttdeci">void pru_stop(void)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00708">pru.c:708</a></div></div>
<div class="ttc" id="pru_8c_html_a307dd06bc7b81f70ae57e66aa9a6d2ca"><div class="ttname"><a href="pru_8c.html#a307dd06bc7b81f70ae57e66aa9a6d2ca">pru_close</a></div><div class="ttdeci">void pru_close(void)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00723">pru.c:723</a></div></div>
<div class="ttc" id="pru_8h_html_ab702106cf3b3e96750b6845ded4e0299"><div class="ttname"><a href="pru_8h.html#ab702106cf3b3e96750b6845ded4e0299">RESET</a></div><div class="ttdeci">#define RESET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00074">pru.h:74</a></div></div>
<div class="ttc" id="pru_8h_html_a20aa8789c2514b7531aa0c80f0bd11a0"><div class="ttname"><a href="pru_8h.html#a20aa8789c2514b7531aa0c80f0bd11a0">SIZE_HIGH</a></div><div class="ttdeci">#define SIZE_HIGH</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00144">pru.h:144</a></div></div>
<div class="ttc" id="structpru__data__struct_html"><div class="ttname"><a href="structpru__data__struct.html">pru_data_struct</a></div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00170">pru.h:170</a></div></div>
<div class="ttc" id="structpru__data__struct_html_a37bf5ecf53ae32ec60d16618e3936fd8"><div class="ttname"><a href="structpru__data__struct.html#a37bf5ecf53ae32ec60d16618e3936fd8">pru_data_struct::precision</a></div><div class="ttdeci">uint32_t precision</div><div class="ttdoc">ADC precision (in bit) </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00174">pru.h:174</a></div></div>
<div class="ttc" id="structweb__shm_html"><div class="ttname"><a href="structweb__shm.html">web_shm</a></div><div class="ttdef"><b>Definition:</b> <a href="web_8h_source.html#l00095">web.h:95</a></div></div>
<div class="ttc" id="types_8h_html_a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90"><div class="ttname"><a href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a2fd6f336d08340583bd620a7f5694c90">ERROR</a></div><div class="ttdoc">Error. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00200">types.h:200</a></div></div>
<div class="ttc" id="meter_8c_html_a5e66adf5332d1946c041c2a2b518ad66"><div class="ttname"><a href="meter_8c.html#a5e66adf5332d1946c041c2a2b518ad66">meter_stop</a></div><div class="ttdeci">void meter_stop(void)</div><div class="ttdef"><b>Definition:</b> <a href="meter_8c_source.html#l00060">meter.c:60</a></div></div>
<div class="ttc" id="structtime__stamp_html_acc8388479ab2df608b5e49c07d757790"><div class="ttname"><a href="structtime__stamp.html#acc8388479ab2df608b5e49c07d757790">time_stamp::nsec</a></div><div class="ttdeci">int64_t nsec</div><div class="ttdoc">Nanoseconds. </div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00049">util.h:49</a></div></div>
<div class="ttc" id="pru_8h_html_a993739431380c1beb0e04a8826c1b7e3"><div class="ttname"><a href="pru_8h.html#a993739431380c1beb0e04a8826c1b7e3">SDATAC</a></div><div class="ttdeci">#define SDATAC</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00079">pru.h:79</a></div></div>
<div class="ttc" id="structrl__conf_html_a3018547f3ec09e34dd9c639eb15fd0d5"><div class="ttname"><a href="structrl__conf.html#a3018547f3ec09e34dd9c639eb15fd0d5">rl_conf::sample_rate</a></div><div class="ttdeci">int sample_rate</div><div class="ttdoc">Sampling rate. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00253">types.h:253</a></div></div>
<div class="ttc" id="pru_8h_html_a447d200a726c25fd923af631584c5597"><div class="ttname"><a href="pru_8h.html#a447d200a726c25fd923af631584c5597">GAIN2</a></div><div class="ttdeci">#define GAIN2</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00104">pru.h:104</a></div></div>
<div class="ttc" id="types_8h_html_abd81d11867ad50357ea8332e8d36cf8aaaa33265d2e12fe02833b6564507c7ac2"><div class="ttname"><a href="types_8h.html#abd81d11867ad50357ea8332e8d36cf8aaaa33265d2e12fe02833b6564507c7ac2">NO_FILE</a></div><div class="ttdoc">No file. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00183">types.h:183</a></div></div>
<div class="ttc" id="pru_8c_html_a8003e1ac7da2ee5ce28b70417f12ecd5"><div class="ttname"><a href="pru_8c.html#a8003e1ac7da2ee5ce28b70417f12ecd5">pru_wait_event</a></div><div class="ttdeci">void * pru_wait_event(void *voidEvent)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00056">pru.c:56</a></div></div>
<div class="ttc" id="types_8h_html_ae3eed11e25c123a4136bd1ea91e5f675"><div class="ttname"><a href="types_8h.html#ae3eed11e25c123a4136bd1ea91e5f675">I2H_INDEX</a></div><div class="ttdeci">#define I2H_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00233">types.h:233</a></div></div>
<div class="ttc" id="pru_8c_html_ab784943bfd599f19fddb98647d2f253c"><div class="ttname"><a href="pru_8c.html#ab784943bfd599f19fddb98647d2f253c">pru_init</a></div><div class="ttdeci">int pru_init(void)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00167">pru.c:167</a></div></div>
<div class="ttc" id="pru_8c_html_acc3c091f1563ead66ab59962f3cfdcc5"><div class="ttname"><a href="pru_8c.html#acc3c091f1563ead66ab59962f3cfdcc5">pru_unmap_memory</a></div><div class="ttdeci">int pru_unmap_memory(void *pru_mmap)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00138">pru.c:138</a></div></div>
<div class="ttc" id="pru_8c_html_aba47632bdb6d911ae56229c7ef017723"><div class="ttname"><a href="pru_8c.html#aba47632bdb6d911ae56229c7ef017723">done</a></div><div class="ttdeci">pthread_cond_t done</div><div class="ttdoc">Notification variable. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00050">pru.c:50</a></div></div>
<div class="ttc" id="rl__server_8c_html_a14e52d9e39f9a51dabdbdc4a15ec7d48"><div class="ttname"><a href="rl__server_8c.html#a14e52d9e39f9a51dabdbdc4a15ec7d48">buffer_sizes</a></div><div class="ttdeci">int buffer_sizes[WEB_RING_BUFFER_COUNT]</div><div class="ttdoc">Buffer sizes for different time scales. </div><div class="ttdef"><b>Definition:</b> <a href="rl__server_8c_source.html#l00074">rl_server.c:74</a></div></div>
<div class="ttc" id="structpru__data__struct_html_a009029f956cb377955c1710e25237362"><div class="ttname"><a href="structpru__data__struct.html#a009029f956cb377955c1710e25237362">pru_data_struct::buffer0_location</a></div><div class="ttdeci">uint32_t buffer0_location</div><div class="ttdoc">Pointer to shared buffer 0. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00178">pru.h:178</a></div></div>
<div class="ttc" id="pru_8c_html_a8beb411e955b815605865150d2b12832"><div class="ttname"><a href="pru_8c.html#a8beb411e955b815605865150d2b12832">pru_sample</a></div><div class="ttdeci">int pru_sample(FILE *data_file, FILE *ambient_file, struct rl_conf *conf, char *file_comment)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00296">pru.c:296</a></div></div>
<div class="ttc" id="types_8h_html_a259c9d48abfd554f093c9a9fe0d9873cabd46128544cc5273b190363804c58aaf"><div class="ttname"><a href="types_8h.html#a259c9d48abfd554f093c9a9fe0d9873cabd46128544cc5273b190363804c58aaf">SAMPLING_ON</a></div><div class="ttdoc">Sampling. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00151">types.h:151</a></div></div>
<div class="ttc" id="structrl__status_html_a3ef63fab68fb13f583327fe7142eeee3"><div class="ttname"><a href="structrl__status.html#a3ef63fab68fb13f583327fe7142eeee3">rl_status::sampling</a></div><div class="ttdeci">rl_sampling sampling</div><div class="ttdoc">Sampling state. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00287">types.h:287</a></div></div>
<div class="ttc" id="types_8h_html_a8e2c970dfb447f044dc6a775cd8d14e4"><div class="ttname"><a href="types_8h.html#a8e2c970dfb447f044dc6a775cd8d14e4">AMBIENT_ENABLED</a></div><div class="ttdeci">#define AMBIENT_ENABLED</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00211">types.h:211</a></div></div>
<div class="ttc" id="util_8c_html_aae37b3d3b6a01f95a54b30585d022b64"><div class="ttname"><a href="util_8c.html#aae37b3d3b6a01f95a54b30585d022b64">count_channels</a></div><div class="ttdeci">int count_channels(int channels[NUM_CHANNELS])</div><div class="ttdef"><b>Definition:</b> <a href="util_8c_source.html#l00080">util.c:80</a></div></div>
<div class="ttc" id="structpru__data__struct_html_ab5654be612b10601bc48c878f512143a"><div class="ttname"><a href="structpru__data__struct.html#ab5654be612b10601bc48c878f512143a">pru_data_struct::buffer1_location</a></div><div class="ttdeci">uint32_t buffer1_location</div><div class="ttdoc">Pointer to shared buffer 1. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00180">pru.h:180</a></div></div>
<div class="ttc" id="types_8h_html_a8488e4c6d9298df81f48a34e80c81410a748005382152808a72b1a9177d9dc806"><div class="ttname"><a href="types_8h.html#a8488e4c6d9298df81f48a34e80c81410a748005382152808a72b1a9177d9dc806">INFO</a></div><div class="ttdoc">Information. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00202">types.h:202</a></div></div>
<div class="ttc" id="types_8h_html_a9cd6c40e97ff3f7786714708a756e064"><div class="ttname"><a href="types_8h.html#a9cd6c40e97ff3f7786714708a756e064">MIN_ADC_RATE</a></div><div class="ttdeci">#define MIN_ADC_RATE</div><div class="ttdoc">Minimal ADC sampling rate. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00134">types.h:134</a></div></div>
<div class="ttc" id="pru_8h_html_ab45eb721b96f7dc4898425c6bdc0ae49"><div class="ttname"><a href="pru_8h.html#ab45eb721b96f7dc4898425c6bdc0ae49">K4</a></div><div class="ttdeci">#define K4</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00112">pru.h:112</a></div></div>
<div class="ttc" id="structpru__data__struct_html_abc2bc058fcb806bc631307c857309b53"><div class="ttname"><a href="structpru__data__struct.html#abc2bc058fcb806bc631307c857309b53">pru_data_struct::commands</a></div><div class="ttdeci">uint32_t commands[NUMBER_ADC_COMMANDS]</div><div class="ttdoc">ADC commands to send. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00188">pru.h:188</a></div></div>
<div class="ttc" id="pru_8c_html_a4d0ce3530455f19eaab044e35a461c4f"><div class="ttname"><a href="pru_8c.html#a4d0ce3530455f19eaab044e35a461c4f">pru_wait_event_timeout</a></div><div class="ttdeci">int pru_wait_event_timeout(unsigned int event, unsigned int timeout)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00079">pru.c:79</a></div></div>
<div class="ttc" id="types_8h_html_acc71aee1a86f329b7380fcd877d8af26"><div class="ttname"><a href="types_8h.html#acc71aee1a86f329b7380fcd877d8af26">I1L_INDEX</a></div><div class="ttdeci">#define I1L_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00230">types.h:230</a></div></div>
<div class="ttc" id="pru_8h_html_a20a140ced2d12dab5beb039c3bd78077aa1dc6393949d4482ff3e195bd85598f0"><div class="ttname"><a href="pru_8h.html#a20a140ced2d12dab5beb039c3bd78077aa1dc6393949d4482ff3e195bd85598f0">PRU_OFF</a></div><div class="ttdoc">PRU off. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00159">pru.h:159</a></div></div>
<div class="ttc" id="structrl__file__lead__in_html_acb3586e15d269a3b56f34e7e6573c698"><div class="ttname"><a href="structrl__file__lead__in.html#acb3586e15d269a3b56f34e7e6573c698">rl_file_lead_in::data_block_count</a></div><div class="ttdeci">uint32_t data_block_count</div><div class="ttdoc">Number of data blocks stored in the file. </div><div class="ttdef"><b>Definition:</b> <a href="rl__file_8h_source.html#l00114">rl_file.h:114</a></div></div>
<div class="ttc" id="pru_8h_html_a4708b2ba51cdb3a41817f06b8982657f"><div class="ttname"><a href="pru_8h.html#a4708b2ba51cdb3a41817f06b8982657f">CH6SET</a></div><div class="ttdeci">#define CH6SET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00096">pru.h:96</a></div></div>
<div class="ttc" id="types_8h_html_a1a6b6fb557d8d37d59700faf4e4c9167ae2e6be25b55c130066f8efb3490b3826"><div class="ttname"><a href="types_8h.html#a1a6b6fb557d8d37d59700faf4e4c9167ae2e6be25b55c130066f8efb3490b3826">METER</a></div><div class="ttdoc">Meter mode (display current values in terminal) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00160">types.h:160</a></div></div>
<div class="ttc" id="pru_8h_html"><div class="ttname"><a href="pru_8h.html">pru.h</a></div></div>
<div class="ttc" id="pru_8h_html_aa284ae96969e8487b1d1f03b6215a98c"><div class="ttname"><a href="pru_8h.html#aa284ae96969e8487b1d1f03b6215a98c">MMAP_FILE</a></div><div class="ttdeci">#define MMAP_FILE</div><div class="ttdoc">Memory map file. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00128">pru.h:128</a></div></div>
<div class="ttc" id="types_8h_html_adc6e5733fc3c22f0a7b2914188c49c90aa549f36d05ca9a052a7d97c2f6fc2cea"><div class="ttname"><a href="types_8h.html#adc6e5733fc3c22f0a7b2914188c49c90aa549f36d05ca9a052a7d97c2f6fc2cea">RL_ERROR</a></div><div class="ttdoc">Error. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00143">types.h:143</a></div></div>
<div class="ttc" id="pru_8h_html_a8fea370fa35eeb28355a58a40783ec99"><div class="ttname"><a href="pru_8h.html#a8fea370fa35eeb28355a58a40783ec99">CH1SET</a></div><div class="ttdeci">#define CH1SET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00091">pru.h:91</a></div></div>
<div class="ttc" id="pru_8c_html_aca3acbd32d5951672e7b2b1523f3c2fa"><div class="ttname"><a href="pru_8c.html#aca3acbd32d5951672e7b2b1523f3c2fa">pru_set_state</a></div><div class="ttdeci">void pru_set_state(rl_pru_state state)</div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00157">pru.c:157</a></div></div>
<div class="ttc" id="pru_8c_html_ad2718fc743dfe4460461ce938718ffa0"><div class="ttname"><a href="pru_8c.html#ad2718fc743dfe4460461ce938718ffa0">waiting</a></div><div class="ttdeci">pthread_mutex_t waiting</div><div class="ttdoc">PRU access mutex. </div><div class="ttdef"><b>Definition:</b> <a href="pru_8c_source.html#l00047">pru.c:47</a></div></div>
<div class="ttc" id="types_8h_html_a7652fb1566ba57e60f1bf36cf15729c7"><div class="ttname"><a href="types_8h.html#a7652fb1566ba57e60f1bf36cf15729c7">DIGITAL_INPUTS_ENABLED</a></div><div class="ttdeci">#define DIGITAL_INPUTS_ENABLED</div><div class="ttdoc">Digital input sampling ensabled. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00242">types.h:242</a></div></div>
<div class="ttc" id="pru_8h_html_a0c1b4ad6599de0f7b18674bf6c3a22fe"><div class="ttname"><a href="pru_8h.html#a0c1b4ad6599de0f7b18674bf6c3a22fe">K16</a></div><div class="ttdeci">#define K16</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00114">pru.h:114</a></div></div>
<div class="ttc" id="pru_8h_html_a018ba15c7462bc82cae0c3695d4c0ed0"><div class="ttname"><a href="pru_8h.html#a018ba15c7462bc82cae0c3695d4c0ed0">CH7SET</a></div><div class="ttdeci">#define CH7SET</div><div class="ttdef"><b>Definition:</b> <a href="pru_8h_source.html#l00097">pru.h:97</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="pru_8c.html">pru.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
